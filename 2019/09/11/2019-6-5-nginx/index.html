<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="知识架构,">










<meta name="description" content="第一章 Nginx 简介 nginx [engine x] is an HTTP and reverse proxy server, a mail proxy server, and a generic TCP/UDP proxy server nginx  是一个高性能的HTTP和反向代理web服务器  1.0 Basic HTTP server features Serving static">
<meta name="keywords" content="知识架构">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx 学习笔记">
<meta property="og:url" content="http://linz.tech/2019/09/11/2019-6-5-nginx/index.html">
<meta property="og:site_name" content="北疆的博客">
<meta property="og:description" content="第一章 Nginx 简介 nginx [engine x] is an HTTP and reverse proxy server, a mail proxy server, and a generic TCP/UDP proxy server nginx  是一个高性能的HTTP和反向代理web服务器  1.0 Basic HTTP server features Serving static">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://cdn.linz.tech/nginx-2019-6-13-io-epoll.png">
<meta property="og:image" content="http://cdn.linz.tech/nginx-2019-6-13-io-sendfile.png">
<meta property="og:image" content="http://cdn.linz.tech/nginx_http_x_forwared_for.png">
<meta property="og:image" content="http://cdn.linz.tech/nginx_cache_last_etag_flow.png">
<meta property="og:image" content="http://cdn.linz.tech/nginx_http_refer.jpg">
<meta property="og:image" content="http://cdn.linz.tech/nginx-proxy-type.png">
<meta property="og:image" content="http://cdn.linz.tech/nginx_upstream.png">
<meta property="og:image" content="http://cdn.linz.tech/nginx_lua_module.png">
<meta property="og:image" content="http://cdn.linz.tech/nginx_lua_api.png">
<meta property="og:image" content="http://cdn.linz.tech/nginx-2019-6-13-io-status.png">
<meta property="og:updated_time" content="2020-04-19T11:56:49.241Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="nginx 学习笔记">
<meta name="twitter:description" content="第一章 Nginx 简介 nginx [engine x] is an HTTP and reverse proxy server, a mail proxy server, and a generic TCP/UDP proxy server nginx  是一个高性能的HTTP和反向代理web服务器  1.0 Basic HTTP server features Serving static">
<meta name="twitter:image" content="http://cdn.linz.tech/nginx-2019-6-13-io-epoll.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'CD2IHLO3Q2',
      apiKey: 'f3890b1e9cf212771f29d3258b186372',
      indexName: 'LocalSearch',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://linz.tech/2019/09/11/2019-6-5-nginx/">





  <title>nginx 学习笔记 | 北疆的博客</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?dd275ba96bfa28cb8bd3809466f17419";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">北疆的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://linz.tech/2019/09/11/2019-6-5-nginx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="北疆">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://cdn.linz.tech/a.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="北疆的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">nginx 学习笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-11T01:49:14+08:00">
                2019-09-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/note/" itemprop="url" rel="index">
                    <span itemprop="name">note</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/09/11/2019-6-5-nginx/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/09/11/2019-6-5-nginx/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 浏览
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>次
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="第一章-Nginx-简介"><a href="#第一章-Nginx-简介" class="headerlink" title="第一章 Nginx 简介"></a>第一章 Nginx 简介</h1><blockquote>
<p>nginx [engine x] is an HTTP and reverse proxy server, a mail proxy server, and a generic TCP/UDP proxy server</p>
<p>nginx  是一个高性能的<a href="https://baike.baidu.com/item/HTTP" target="_blank" rel="noopener">HTTP</a>和<a href="https://baike.baidu.com/item/反向代理/7793488" target="_blank" rel="noopener">反向代理</a>web服务器</p>
</blockquote>
<h2 id="1-0-Basic-HTTP-server-features"><a href="#1-0-Basic-HTTP-server-features" class="headerlink" title="1.0 Basic HTTP server features"></a>1.0 Basic HTTP server features</h2><ul>
<li>Serving static and <a href="https://nginx.org/en/docs/http/ngx_http_index_module.html" target="_blank" rel="noopener">index</a> files, <a href="https://nginx.org/en/docs/http/ngx_http_autoindex_module.html" target="_blank" rel="noopener">autoindexing</a>; <a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#open_file_cache" target="_blank" rel="noopener">open file descriptor cache</a>;</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html" target="_blank" rel="noopener">Accelerated reverse proxying with caching</a>; <a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html" target="_blank" rel="noopener">load balancing and fault tolerance</a>;</li>
<li>Accelerated support with caching of <a href="https://nginx.org/en/docs/http/ngx_http_fastcgi_module.html" target="_blank" rel="noopener">FastCGI</a>, <a href="https://nginx.org/en/docs/http/ngx_http_uwsgi_module.html" target="_blank" rel="noopener">uwsgi</a>, <a href="https://nginx.org/en/docs/http/ngx_http_scgi_module.html" target="_blank" rel="noopener">SCGI</a>, and <a href="https://nginx.org/en/docs/http/ngx_http_memcached_module.html" target="_blank" rel="noopener">memcached</a> servers; <a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html" target="_blank" rel="noopener">load balancing and fault tolerance</a>;</li>
<li>Modular architecture. Filters include <a href="https://nginx.org/en/docs/http/ngx_http_gzip_module.html" target="_blank" rel="noopener">gzipping</a>, byte ranges, chunked responses, <a href="https://nginx.org/en/docs/http/ngx_http_xslt_module.html" target="_blank" rel="noopener">XSLT</a>, <a href="https://nginx.org/en/docs/http/ngx_http_ssi_module.html" target="_blank" rel="noopener">SSI</a>, and <a href="https://nginx.org/en/docs/http/ngx_http_image_filter_module.html" target="_blank" rel="noopener">image transformation</a> filter. Multiple SSI inclusions within a single page can be processed in parallel if they are handled by proxied or FastCGI/uwsgi/SCGI servers;</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html" target="_blank" rel="noopener">SSL and TLS SNI support</a>;</li>
<li>Support for <a href="https://nginx.org/en/docs/http/ngx_http_v2_module.html" target="_blank" rel="noopener">HTTP/2</a> with weighted and dependency-based prioritization.</li>
</ul>
<h2 id="2-0-Other-HTTP-server-features"><a href="#2-0-Other-HTTP-server-features" class="headerlink" title="2.0 Other HTTP server features"></a>2.0 Other HTTP server features</h2><ul>
<li>Name-based and IP-based <a href="https://nginx.org/en/docs/http/request_processing.html" target="_blank" rel="noopener">virtual servers</a>;</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#keepalive_timeout" target="_blank" rel="noopener">Keep-alive</a> and pipelined connections support;</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_log_module.html#log_format" target="_blank" rel="noopener">Access log formats</a>, <a href="https://nginx.org/en/docs/http/ngx_http_log_module.html#access_log" target="_blank" rel="noopener">buffered log writing</a>, <a href="https://nginx.org/en/docs/control.html#logs" target="_blank" rel="noopener">fast log rotation</a>, and <a href="https://nginx.org/en/docs/syslog.html" target="_blank" rel="noopener">syslog logging</a>;</li>
<li>3xx-5xx error codes <a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#error_page" target="_blank" rel="noopener">redirection</a>;</li>
<li>The rewrite module: <a href="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html" target="_blank" rel="noopener">URI changing using regular expressions</a>;</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#if" target="_blank" rel="noopener">Executing different functions</a> depending on the <a href="https://nginx.org/en/docs/http/ngx_http_geo_module.html" target="_blank" rel="noopener">client address</a>;</li>
<li>Access control based on <a href="https://nginx.org/en/docs/http/ngx_http_access_module.html" target="_blank" rel="noopener">client IP address</a>, <a href="https://nginx.org/en/docs/http/ngx_http_auth_basic_module.html" target="_blank" rel="noopener">by password (HTTP Basic authentication)</a> and by the<a href="https://nginx.org/en/docs/http/ngx_http_auth_request_module.html" target="_blank" rel="noopener">result of subrequest</a>;</li>
<li>Validation of <a href="https://nginx.org/en/docs/http/ngx_http_referer_module.html" target="_blank" rel="noopener">HTTP referer</a>;</li>
<li>The <a href="https://nginx.org/en/docs/http/ngx_http_dav_module.html" target="_blank" rel="noopener">PUT, DELETE, MKCOL, COPY, and MOVE</a> methods;</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_flv_module.html" target="_blank" rel="noopener">FLV</a> and <a href="https://nginx.org/en/docs/http/ngx_http_mp4_module.html" target="_blank" rel="noopener">MP4</a> streaming;</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#limit_rate" target="_blank" rel="noopener">Response rate limiting</a>;</li>
<li>Limiting the number of simultaneous <a href="https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html" target="_blank" rel="noopener">connections</a> or <a href="https://nginx.org/en/docs/http/ngx_http_limit_req_module.html" target="_blank" rel="noopener">requests</a> coming from one address;</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_geoip_module.html" target="_blank" rel="noopener">IP-based geolocation</a>;</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_split_clients_module.html" target="_blank" rel="noopener">A/B testing</a>;</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_mirror_module.html" target="_blank" rel="noopener">Request mirroring</a>;</li>
<li>Embedded <a href="https://nginx.org/en/docs/http/ngx_http_perl_module.html" target="_blank" rel="noopener">Perl</a>;</li>
<li><a href="https://nginx.org/en/docs/njs/index.html" target="_blank" rel="noopener">njs</a> scripting language.</li>
</ul>
<h2 id="3-0-TCP-UDP-proxy-server-features"><a href="#3-0-TCP-UDP-proxy-server-features" class="headerlink" title="3.0 TCP/UDP proxy server features"></a>3.0 TCP/UDP proxy server features</h2><ul>
<li><p><a href="https://nginx.org/en/docs/stream/ngx_stream_proxy_module.html" target="_blank" rel="noopener">Generic proxying</a> of TCP and UDP;</p>
</li>
<li><p><a href="https://nginx.org/en/docs/stream/ngx_stream_ssl_module.html" target="_blank" rel="noopener">SSL</a> and TLS <a href="https://nginx.org/en/docs/stream/ngx_stream_ssl_preread_module.html" target="_blank" rel="noopener">SNI</a> support for TCP;</p>
</li>
<li><p><a href="https://nginx.org/en/docs/stream/ngx_stream_upstream_module.html" target="_blank" rel="noopener">Load balancing and fault tolerance</a>;</p>
</li>
<li><p>Access control based on <a href="https://nginx.org/en/docs/stream/ngx_stream_access_module.html" target="_blank" rel="noopener">client address</a>;</p>
</li>
<li><p>Executing different functions depending on the <a href="https://nginx.org/en/docs/stream/ngx_stream_geo_module.html" target="_blank" rel="noopener">client address</a>;</p>
</li>
<li><p>Limiting the number of simultaneous <a href="https://nginx.org/en/docs/stream/ngx_stream_limit_conn_module.html" target="_blank" rel="noopener">connections</a> coming from one address;</p>
</li>
<li><p><a href="https://nginx.org/en/docs/stream/ngx_stream_log_module.html#log_format" target="_blank" rel="noopener">Access log formats</a>, <a href="https://nginx.org/en/docs/stream/ngx_stream_log_module.html#access_log" target="_blank" rel="noopener">buffered log writing</a>, <a href="https://nginx.org/en/docs/control.html#logs" target="_blank" rel="noopener">fast log rotation</a>, and <a href="https://nginx.org/en/docs/syslog.html" target="_blank" rel="noopener">syslog logging</a>;</p>
</li>
<li><p><a href="https://nginx.org/en/docs/stream/ngx_stream_geoip_module.html" target="_blank" rel="noopener">IP-based geolocation</a>;</p>
</li>
<li><p><a href="https://nginx.org/en/docs/stream/ngx_stream_split_clients_module.html" target="_blank" rel="noopener">A/B testing</a>;</p>
</li>
<li><p><a href="https://nginx.org/en/docs/njs/index.html" target="_blank" rel="noopener">njs</a> scripting language.</p>
<h2 id="4-0-Nginx-优点"><a href="#4-0-Nginx-优点" class="headerlink" title="4.0 Nginx 优点"></a>4.0 Nginx 优点</h2></li>
</ul>
<ol>
<li><p>IO 多路复用epoll<br><img src="http://cdn.linz.tech/nginx-2019-6-13-io-epoll.png" alt></p>
<blockquote>
<p>什么是IO多路复用： 多个描述符的I/O操作都能在一个线程内并发交替地顺序完成，其中<code>复用</code>指复用同一个线程。</p>
</blockquote>
</li>
<li><p>轻量级，功能模块化，代码模块化</p>
</li>
<li><p>CPU亲和（afflinity）</p>
<blockquote>
<p>什么是CPU亲和： 是一种CPU核心和Nginx工作进程绑定的方式，把没一个Worker进程固定在一个cpu上执行，减少切换cpu的cache miss, 获取更好的性能。</p>
</blockquote>
</li>
<li><p>sendFile<br><img src="http://cdn.linz.tech/nginx-2019-6-13-io-sendfile.png" alt></p>
</li>
</ol>
<h1 id="第二章-基础篇"><a href="#第二章-基础篇" class="headerlink" title="第二章 基础篇"></a>第二章 基础篇</h1><h2 id="Nginx快速搭建"><a href="#Nginx快速搭建" class="headerlink" title="Nginx快速搭建"></a>Nginx快速搭建</h2><p>官网： <a href="http://nginx.org/" target="_blank" rel="noopener">http://nginx.org/</a></p>
<p>Mainline version 开发版本</p>
<p>Stable version 稳定版本</p>
<p>Legacy version 历史版本</p>
<h3 id="Pre-Built-Packages"><a href="#Pre-Built-Packages" class="headerlink" title="Pre-Built Packages"></a>Pre-Built Packages</h3><p>有对应系统的安装方式 <a href="http://nginx.org/en/linux_packages.html" target="_blank" rel="noopener">linux_package</a></p>
<pre class="line-numbers language-shell"><code class="language-shell">vim /etc/yum.repos.d/nginx.repos<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="Nginx-基本命令使用"><a href="#Nginx-基本命令使用" class="headerlink" title="Nginx 基本命令使用"></a>Nginx 基本命令使用</h2><p>Ø  -h：显示帮助信息</p>
<p>Ø  -v：显示Tengine版本</p>
<p>Ø  -m：显示所有静态编译的模块</p>
<p>Ø  -l：显示所有可配置的指令</p>
<p>Ø  -V：显示版本、编译安装时的选项、所有静态编译的模块</p>
<p>Ø  -t：检查Tengine配置文件语法</p>
<p>Ø  -s [stop | quit | reopen | reload]：关闭 | 退出 | 重新打开 | 重载Tengine</p>
<ul>
<li><a href="https://www.cnblogs.com/jiangwangxiang/p/8481661.html" target="_blank" rel="noopener">windows下nginx的安装及使用</a> </li>
</ul>
<pre class="line-numbers language-shell"><code class="language-shell">  start nginx
  nginx -s stop(快速停止nginx)  或  nginx -s quit(完整有序的停止nginx)
  nginx.exe -t # 测试conf
  nginx.exe -s reload #重新加载conf
  taskkill /IM  nginx.exe  /F # kill 所有后台nginx实例<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>Nginx 常用命令</li>
</ul>
<pre class="line-numbers language-shell"><code class="language-shell">  sudo nginx #打开 nginx
  nginx -s reload|reopen|stop|quit  #重新加载配置|重启|停止|退出 nginx
  nginx -t   #测试配置是否有语法错误

  nginx [-?hvVtq] [-s signal] [-c filename] [-p prefix] [-g directives]

  -?,-h           : 打开帮助信息
  -v              : 显示版本信息并退出
  -V              : 显示版本和配置选项信息，然后退出
  -t              : 检测配置文件是否有语法错误，然后退出
  -q              : 在检测配置文件期间屏蔽非错误信息
  -s signal       : stop（停止）, quit（退出）, reopen（重启）, reload
  -p prefix       : 设置前缀路径（默认是：/usr/local/Cellar/nginx/1.2.6/）
  -c filename     : 设置配置文件（默认是：/usr/local/etc/nginx/nginx.conf）
  -g directives   : 设置配置文件外的全局指令<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>nginx -t  能查看配置文件所在目录</p>
<pre class="line-numbers language-shell"><code class="language-shell">nginx: the configuration file /usr/local/tengine/conf/nginx.conf syntax is ok
nginx: configuration file /usr/local/tengine/conf/nginx.conf test is successful<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>阿里云后台配置文件路径：<code>/usr/local/tengine/conf/nginx.conf</code></p>
<h2 id="Nginx的目录和配置语法"><a href="#Nginx的目录和配置语法" class="headerlink" title="Nginx的目录和配置语法"></a>Nginx的目录和配置语法</h2><h3 id="Building-nginx-from-Sources"><a href="#Building-nginx-from-Sources" class="headerlink" title="Building nginx from Sources"></a>Building nginx from Sources</h3><p><a href="https://nginx.org/en/docs/configure.html" target="_blank" rel="noopener">https://nginx.org/en/docs/configure.html</a></p>
<h3 id="Core-functionality"><a href="#Core-functionality" class="headerlink" title="Core functionality"></a>Core functionality</h3><p><a href="https://nginx.org/en/docs/ngx_core_module.html" target="_blank" rel="noopener">https://nginx.org/en/docs/ngx_core_module.html</a></p>
<p>日志目录 </p>
<p>tengine -&gt; /usr/local/tengine/logs</p>
<p>查看nginx的配置</p>
<pre class="line-numbers language-shell"><code class="language-shell">nginx -V<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="配置模块化"><a href="#配置模块化" class="headerlink" title="配置模块化"></a>配置模块化</h3><p>不同功能的配置文件尽量单独编写，使配置文件解耦</p>
<pre class="line-numbers language-shell"><code class="language-shell">http {
    #导入servers/目录下所有conf文件
    include servers/*.conf;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><ol>
<li>自定义错误页</li>
</ol>
<pre class="line-numbers language-shell"><code class="language-shell">   location /bbs {
       root /vhosts/bbs;
       error_page 404 404/404.html;
   }
   error_page 500 502 503 504 /50x.html;
   location = /50x.html {
           root /usr/share/nginx/html;
   }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Nginx-日志-log-fromat"><a href="#Nginx-日志-log-fromat" class="headerlink" title="Nginx 日志 log_fromat"></a>Nginx 日志 log_fromat</h3><h3 id="简单的访问控制"><a href="#简单的访问控制" class="headerlink" title="简单的访问控制"></a>简单的访问控制</h3><h4 id="基于来源IP实现访问控制"><a href="#基于来源IP实现访问控制" class="headerlink" title="基于来源IP实现访问控制"></a>基于来源IP实现访问控制</h4><pre class="line-numbers language-shell"><code class="language-shell">server{
    location / {
        # 网段的写法：192.168.1.0/24
        deny 192.168.1.222;
        # 从上到下进行匹配，类似iptables
        allow all;
    }

    location /bbs {
        if ( $remote_addr = 192.168.1.146 ) {
        return 404;
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="基于用户名-密码实现访问控制"><a href="#基于用户名-密码实现访问控制" class="headerlink" title="基于用户名/密码实现访问控制"></a>基于用户名/密码实现访问控制</h4><pre class="line-numbers language-shell"><code class="language-shell">location /bbs {
    auth_basic "Please Login";
    auth_basic_user_file /usr/local/tengine/conf/.htpasswd;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>设置账户密码</p>
<pre class="line-numbers language-shell"><code class="language-shell">yum -y install httpd-tools
cd /usr/local/tengine/conf
htpasswd -c -m .htpasswd keyso     //用户名keyso，密码123456
nginx -t
nginx -s reload<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>htpasswd</strong></p>
<p>  -c：自动创建账号文件<strong>（仅在添加第一个用户时使用该选项）</strong></p>
<p> -m：使用MD5加密用户密码</p>
<p> -s：使用SHA加密用户密码</p>
<p>  -D：删除指定用户</p>
<h4 id="禁止访问某一类资源"><a href="#禁止访问某一类资源" class="headerlink" title="禁止访问某一类资源"></a>禁止访问某一类资源</h4><pre class="line-numbers language-shell"><code class="language-shell">location ~ \.(txt|doc)$ {
    if (-f $request_filename){
        root html;
        break;
    }
    deny all;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Nginx-变量"><a href="#Nginx-变量" class="headerlink" title="Nginx 变量"></a>Nginx 变量</h3><p>HTTP请求变量 - arg_PARAMETER, http_HEADER, sent_http_HEADER</p>
<p>内置变量 - Nginx内置变量 <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#Embedded%20Variables" target="_blank" rel="noopener">Embedded Variables</a></p>
<h4 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h4><pre><code>server {
    set $foo hello;
    location /test/ {
        default_type application/json;
        return 200 &#39;{&quot;status&quot;:&quot;${foo}/$foo&quot;}&#39;;
    }
}</code></pre><ul>
<li><p>定义范围：<code>server{}</code> 内</p>
<blockquote>
<p>放到外面报错<code>nginx: [emerg] &quot;set&quot; directive is not allowed here</code></p>
</blockquote>
</li>
<li><p>初始化：在加载conf的时候，故没有set变量直接引用无法启动 </p>
</li>
</ul>
<pre><code>server {
    listen 8080;

    location /foo {
        set $a hello;
        echo_exec /bar; #内部跳转a值不变
    }

    location /bar {
        #可以看出定义在location范围之外，赋值是在location内
        echo &quot;a = [$a]&quot;; 
    }
}
</code></pre><p>测试</p>
<pre><code>[root@localhost html]# curl localhost/foo
#内部跳转a值不变
a = [hello]
[root@localhost html]# curl &#39;http://localhost/bar&#39;
#外部跳转没有赋值
a = []</code></pre><h4 id="内建变量"><a href="#内建变量" class="headerlink" title="内建变量"></a>内建变量</h4><p>参考 深度学习之 <code>Nginx 变量</code></p>
<h4 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h4><p>参考 <code>附录二 Nginx全局变量解析</code></p>
<h2 id="Nginx-模块讲解"><a href="#Nginx-模块讲解" class="headerlink" title="Nginx 模块讲解"></a>Nginx 模块讲解</h2><blockquote>
<p>分为 官方模块，第三方模块<br> 官方模块参数：  <a href="https://nginx.org/en/docs/" target="_blank" rel="noopener">Modules reference</a></p>
</blockquote>
<h3 id="常用的模块用法"><a href="#常用的模块用法" class="headerlink" title="常用的模块用法"></a><strong>常用的模块用法</strong></h3><p><a href="https://nginx.org/en/docs/http/ngx_http_stub_status_module.html" target="_blank" rel="noopener">ngx_http_stub_status_module</a> 提供访问的基本状态信息</p>
<p>编译选项： –with-http_stub_status_module</p>
<p>用法</p>
<pre class="line-numbers language-shell"><code class="language-shell">location /status {
    stub_status on;
    allow 192.168.101.120;
    deny all;
    access_log off;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a href="https://nginx.org/en/docs/http/ngx_http_random_index_module.html" target="_blank" rel="noopener">ngx_http_random_index_module</a> 随机Index.html</p>
<p>用法</p>
<pre class="line-numbers language-shell"><code class="language-shell">location / {
    root /usr/src/nginx/;
     random_index on;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>在<code>/usr/src/nginx/</code> 下新建1.html,2.html,3.html ，访问<code>/</code> 会随机访问以上三个文件</p>
<p><a href="https://nginx.org/en/docs/http/ngx_http_sub_module.html" target="_blank" rel="noopener">ngx_http_sub_module</a> 指定字符串的替换</p>
<p>编译选项：  <code>--with-http_sub_module</code></p>
<blockquote>
<pre><code>location / {
    sub_filter &#39;&lt;a href=&quot;http://127.0.0.1:8080/&#39;  &#39;&lt;a href=&quot;https://$host/&#39;;
    sub_filter &#39;&lt;img src=&quot;http://127.0.0.1:8080/&#39; &#39;&lt;img src=&quot;https://$host/&#39;;
    sub_filter_once on; ## 默认为全部替换，开启替换一次
}</code></pre></blockquote>
<h3 id="Nginx-请求限制"><a href="#Nginx-请求限制" class="headerlink" title="Nginx 请求限制"></a>Nginx 请求限制</h3><h4 id="链接频率限制"><a href="#链接频率限制" class="headerlink" title="链接频率限制 :"></a>链接频率限制 :</h4><p><a href="https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html" target="_blank" rel="noopener">ngx_http_limit_conn_module</a></p>
<blockquote>
<p>this module is used to limit the number of connections per the defined key, in particular, the number of connections from a single IP address.</p>
<p>Not all connections are counted. A connection is counted only if it has a request being processed by the server and the whole request header has already been read.</p>
</blockquote>
<p>Directives</p>
<table>
<thead>
<tr>
<th align="left">Syntax:</th>
<th><code>**limit_conn** *zone* *number*;</code></th>
</tr>
</thead>
<tbody><tr>
<td align="left">Default:</td>
<td>—</td>
</tr>
<tr>
<td align="left">Context:</td>
<td><code>http</code>, <code>server</code>, <code>location</code></td>
</tr>
</tbody></table>
<p> Example Configuration</p>
<pre class="line-numbers language-shell"><code class="language-shell">limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn_zone $server_name zone=perserver:10m;

server {
    ...
    limit_conn perip 10; #每个IP allow 10 connections 
    limit_conn perserver 100;#每个服务 allow 10 connections 
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意：HTTP/2 复用的连接是分开计数的，原文：<br> In HTTP/2 and SPDY, each concurrent request is considered a separate connection. </p>
<h4 id="请求频率限制-："><a href="#请求频率限制-：" class="headerlink" title="请求频率限制 ："></a>请求频率限制 ：</h4><p><a href="https://nginx.org/en/docs/http/ngx_http_limit_req_module.html" target="_blank" rel="noopener">ngx_http_limit_req_module</a></p>
<blockquote>
<p>this module (0.7.21) is used to limit the request processing rate per a defined key, in particular, the processing rate of requests coming from a single IP address. The limitation is done using the “leaky bucket” method.</p>
</blockquote>
<p>Example Configuration</p>
<pre class="line-numbers language-shelll"><code class="language-shelll">limit_req_zone $binary_remote_addr zone=perip:10m rate=1r/s;
limit_req_zone $server_name zone=perserver:10m rate=10r/s; #(r/m)
server {
    ...
    limit_req zone=perip burst=5 nodelay;
    limit_req zone=perserver burst=10;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>－　burst 下一个周期继续响应5个reqest超过1r/s，当超过5个request的时候看 [nodelay | delay=<em>number</em>] 怎么处理</p>
<p>Directives</p>
<p>| Syntax:  | <code>**limit_req** zone=*name* [burst=*number*] [nodelay | delay=*number*];</code> |<br>| :——- | ———————————————————— |<br>| Default: | —                                                            |<br>| Context: | <code>http</code>, <code>server</code>, <code>location</code>                                 |</p>
<h3 id="Nginx-访问控制"><a href="#Nginx-访问控制" class="headerlink" title="Nginx 访问控制"></a>Nginx 访问控制</h3><p>auth_mod.conf</p>
<h4 id="基于IP"><a href="#基于IP" class="headerlink" title="基于IP"></a>基于IP</h4><ul>
<li><a href="https://nginx.org/en/docs/http/ngx_http_access_module.html" target="_blank" rel="noopener">ngx_http_access_module</a></li>
</ul>
<p>| Syntax:  | <code>**allow** *address* | *CIDR* | unix: | all;</code> |<br>| :——- | ——————————————— |<br>| Default: | —                                             |<br>| Context: | <code>http</code>, <code>server</code>, <code>location</code>, <code>limit_except</code>  |</p>
<p>CIDR 网段</p>
<p>Sample Configuration</p>
<pre class="line-numbers language-shell"><code class="language-shell">location / {
    deny  192.168.1.1;
    allow 192.168.1.0/24;
    allow 10.1.1.0/16;
    allow 2001:0db8::/32;
    deny  all;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>过个IP用ngx_http_geo_module定义</p>
<p>access_module存在的局限性，及当client通过代理访问是remote_addr是不同的</p>
<p>解决方案一</p>
<p><img src="http://cdn.linz.tech/nginx_http_x_forwared_for.png" alt></p>
<p>存在问题是，http_x_forwarded_for是协议要求，厂商可以不实现且可以修改</p>
<p>解决方案二 HTP自定义变量</p>
<h4 id="基于用户信任登录"><a href="#基于用户信任登录" class="headerlink" title="基于用户信任登录"></a>基于用户信任登录</h4><ul>
<li><a href="https://nginx.org/en/docs/http/ngx_http_auth_basic_module.html" target="_blank" rel="noopener">ngx_http_auth_basic_module</a></li>
</ul>
<p>Sample Configuration</p>
<pre class="line-numbers language-shell"><code class="language-shell">location / {
    auth_basic           "Auth access test ! input your password!";
    auth_basic_user_file conf/htpasswd;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>auth_basic_user_file</strong> </p>
<pre class="line-numbers language-xml"><code class="language-xml"># comment 用户名:密码:描述
name1:password1
name2:password2:comment
name3:password3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>加密密码：htpasswd</p>
<pre class="line-numbers language-shell"><code class="language-shell">yum install httpd-tools -y 
htpasswd -c ./auth_conf jeson # -c 指定生成文件 jeson 用户名<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>局限性</p>
<ol>
<li>用户信息依赖文件方式</li>
<li>操作管理机械，效率低下</li>
</ol>
<p>解决方案：</p>
<ol>
<li>Nginx结合LUA实现高效验证</li>
<li>Nginx和LDAP打通，利用nginx-auth-ldap模块 </li>
</ol>
<h1 id="第三章-场景实践"><a href="#第三章-场景实践" class="headerlink" title="第三章 场景实践"></a>第三章 场景实践</h1><h2 id="Nginx作为静态资源WEB服务"><a href="#Nginx作为静态资源WEB服务" class="headerlink" title="Nginx作为静态资源WEB服务"></a>Nginx作为静态资源WEB服务</h2><h3 id="1-静态资源服务场景-CDN"><a href="#1-静态资源服务场景-CDN" class="headerlink" title="1, 静态资源服务场景-CDN"></a>1, 静态资源服务场景-CDN</h3><h3 id="2-配置语法"><a href="#2-配置语法" class="headerlink" title="2 配置语法"></a>2 配置语法</h3><p>tcp_nopush<br>原理：多个包集中发送，适合大文件开启</p>
<pre class="line-numbers language-shell"><code class="language-shell">Syntax: tcp_nopush on | off;
Default: tcp_nopush off;
Context: http, server, location <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>作用： sendfile开启的情况下，提高网络包的传输效率</p>
<p> tcp_nodelay</p>
<pre class="line-numbers language-shel"><code class="language-shel">Syntax: tcp_nodelay on | off;
Default: on
Context: http, server, location <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>作用： keepalive连接下，提高网络包的传输实时性；</p>
<h3 id="3-压缩"><a href="#3-压缩" class="headerlink" title="3. 压缩"></a>3. 压缩</h3><ul>
<li><a href="https://nginx.org/en/docs/http/ngx_http_gzip_module.html" target="_blank" rel="noopener">ngx_http_gzip_module</a></li>
</ul>
<p>Sample_confuration</p>
<pre class="line-numbers language-shell"><code class="language-shell">gzip            on;
gzip_min_length 1000;
gzip_proxied    expired no-cache no-store private auth;
gzip_types      text/plain application/xml;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>压缩</p>
<pre class="line-numbers language-shell"><code class="language-shell">Syntax: gzip on | off;
Default: off;
Context: http, server, location, if in location<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>压缩比</p>
<pre class="line-numbers language-shell"><code class="language-shell">Syntax: gzip_comp_level level;
Default: 1;
Context: http, server, location<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>压缩版本</p>
<pre class="line-numbers language-shell"><code class="language-shell">Syntax: gzip_http_version 1.0 | 1.1;
Default: gzip_http_version 1.1; # 主流
Context: http, server, location<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="4-浏览器缓存原理"><a href="#4-浏览器缓存原理" class="headerlink" title="4 浏览器缓存原理"></a>4 浏览器缓存原理</h3><p><strong>客户端浏览器缓存原理</strong></p>
<p>etag lastmodified 缓存原理流程图</p>
<p><img src="http://cdn.linz.tech/nginx_cache_last_etag_flow.png" alt></p>
<p>Expires 配置语法</p>
<pre class="line-numbers language-shell"><code class="language-shell">Syntax: expires  [modified] time;
        expires epoch | max | off;
Default: expires off;
Context: http, server, location, if in location<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>Sample 以<code>.html/htm</code>结尾的文件过期时间为24小时</p>
<pre class="line-numbers language-shell"><code class="language-shell">location ~ .*\.(htm|html)$ {
    expires 24h;
    root /opt/app/code;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="5-跨域访问"><a href="#5-跨域访问" class="headerlink" title="5 跨域访问"></a>5 跨域访问</h3><ol>
<li>浏览器禁止跨域的原因<br>不安全容易出现CSRF攻击！ CSRF攻击是攻击者利用用户的身份操作用户帐户的一种攻击方式，通常使用Anti CSRF Token来防御CSRF攻击，同时要注意Token的保密性和随机性。</li>
</ol>
<pre class="line-numbers language-shell"><code class="language-shell">  location / {
        add_header 'Access-Control-Allow-Origin' '*'; # * 允许所有站点跨域访问
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Allow-Methods' '*'; # GET,POST,PUT,DELETE,OPTIONS; * 指所有 
        proxy_pass http://localhost:8088;
        # proxy_redirect off ;
        index index.php index.html index.htm;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置Nginx 允许多个域名跨域访问</p>
<p>异常</p>
<pre class="line-numbers language-shell"><code class="language-shell">No'Access-Control-Allow-Origin' header is present on the requested resourse.Origin 'http//localhost:8088' is therefore not allowed access.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>解决</p>
<pre class="line-numbers language-shell"><code class="language-shell">map $http_origin $corsHost {
    default 0;
    "~http://www.haibakeji.com" http://www.haibakeji.com;
    "~http://m.haibakeji.com" http://m.haibakeji.com;
    "~http://wap.haibakeji.com" http://wap.haibakeji.com;
}
server
{
    listen 80;
    server_name www.haibakeji.com;
    root /nginx;
    location /
    {
        add_header Access-Control-Allow-Origin $corsHost;
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-防盗链接"><a href="#6-防盗链接" class="headerlink" title="6 防盗链接"></a>6 防盗链接</h3><ul>
<li><a href="https://nginx.org/en/docs/http/ngx_http_referer_module.html" target="_blank" rel="noopener">ngx_http_referer_module</a></li>
</ul>
<p>原因： 1. 防止资源被盗用，2. 防止非法抓取资源导致网站卡顿；</p>
<p>http_refer </p>
<p><img src="http://cdn.linz.tech/nginx_http_refer.jpg" alt></p>
<pre class="line-numbers language-shell"><code class="language-shell">Syntax: valid_referers none | blocked | server_names | string ...;
Context: server, location<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<blockquote>
<p>请求头为指定值时， 内嵌变量$invalid_referer被设置为空字符串， 否则这个变量会被置成“1”。查找匹配时不区分大小写。</p>
<ul>
<li>blocked：“Referer” 请求头存在，但是它的值被防火墙或者代理服务器删除；这些值都不以“http://” 或者 “https://”字符串作为开头；</li>
<li>none：缺少“Referer”请求头；</li>
<li>server_names：“Referer” 请求头包含某个虚拟主机名；</li>
</ul>
<p>正则表达式：必须以“~”符号作为开头。 需要注意的是表达式会从“http://”或者“https://”之后的文本开始匹配。</p>
</blockquote>
<p>Sample</p>
<pre class="line-numbers language-java"><code class="language-java">location <span class="token operator">~</span> <span class="token punctuation">.</span>*<span class="token punctuation">.</span><span class="token punctuation">(</span>jpg<span class="token operator">|</span>gif<span class="token operator">|</span>png<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>
    # 允许那些referers信息进行访问 
    # ndne 允许没有带referer信息的过来
    # blocked 允许没有带协议信息，如http的
    # <span class="token operator">~</span><span class="token operator">/</span>google\<span class="token punctuation">.</span>/ #所有 <span class="token operator">~</span><span class="token operator">/</span>google\<span class="token punctuation">.</span>/过来的
    valid_referers none blocked <span class="token number">116.62</span><span class="token punctuation">.</span><span class="token number">103.228</span> <span class="token operator">~</span><span class="token operator">/</span>google\<span class="token punctuation">.</span>/<span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span>$invalid_referer<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">403</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a href="https://blog.51cto.com/woymk/1893774" target="_blank" rel="noopener">利用nginx“ngx_http_referer_module”模块设置防盗链</a></p>
<h2 id="Nginx作为代理服务"><a href="#Nginx作为代理服务" class="headerlink" title="Nginx作为代理服务"></a>Nginx作为代理服务</h2><ul>
<li><a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html" target="_blank" rel="noopener">ngx_http_proxy_module</a></li>
</ul>
<p>nginx 支持的代理类型</p>
<p><img src="http://cdn.linz.tech/nginx-proxy-type.png" alt></p>
<p>代理分为正向代理和反向代理</p>
<p>fx_proxy.conf</p>
<p>模板设置</p>
<pre class="line-numbers language-shell"><code class="language-shell">server{
    listen 80;
    server_name locahost jeson.t.imooc.io;
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_redirect default;
        #访问日志配置， 传递真的地址给proxy，而不是当前nginx
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;

        proxy_connect_timeout 30; #30s
        proxy_send_timeout 60;
        proxy_read_timeout 60;

        proxy_buffer_size 32k;
        proxy_buffering on; 
        proxy_buffers 4 128k;
        proxy_busy_buffers_size 256k;
        proxy_max_temp_file_size 256k; #config时指定 --http-proxy-temp-path=
        #当出现一下异常是启用下一个 upstream
         proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件形式导入</p>
<pre class="line-numbers language-shell"><code class="language-shell">location {
    include proxy_params;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>proxy_params;</p>
<pre class="line-numbers language-shell"><code class="language-shell">proxy_redirect default;

proxy_set_header Host $http_host;
proxy_set_header X-Real-IP $remote_addr;

proxy_connect_timeout 30; #30s
proxy_send_timeout 60;
proxy_read_timeout 60;

proxy_buffer_size 32k;
proxy_buffering on; 
proxy_buffers 4 128k;
proxy_busy_buffers_size 256k;
proxy_max_temp_file_size 256k; #config时指定 --http-proxy-temp-path=<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="转发路径规则"><a href="#转发路径规则" class="headerlink" title="转发路径规则"></a>转发路径规则</h3><p>真实请求路径<code>http://localhost/online/wxapi/test/loginSwitch</code></p>
<p>第一种：proxy_pass 结尾有<code>/</code></p>
<pre><code>location /online/wxapi/ {
        proxy_pass http://localhost:8080/; #转发不代 location 路径
}</code></pre><p>代理结果：<code>http://localhost:8080/test/loginSwitch</code></p>
<p>第二种：proxy_pass 结尾没有<code>/</code></p>
<pre><code>location /online/wxapi/ {
        proxy_pass http://localhost:8080;#转发代 location 路径
}</code></pre><p>代理结果：<code>http://localhost:8080/online/wxapi/test/loginSwitch</code></p>
<p>第三种：proxy_pass 结尾有<code>/web</code></p>
<pre><code>location /online/wxapi/ {
        proxy_pass http://localhost:8080/web;#转发location路径,直接拼接，不带`/`分割符
}</code></pre><p>代理结果：<code>http://localhost:8080/webtest/loginSwitch</code></p>
<p>第二种：proxy_pass 结尾没有<code>/web/</code></p>
<pre><code>location /online/wxapi/ {
        proxy_pass http://localhost:8080/web/;#转发代 location 路径
}</code></pre><p>代理结果：<code>http://localhost:8080/web/test/loginSwitch</code></p>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><pre class="line-numbers language-shell"><code class="language-shell">location ^~ /static/ 
{     
    #不传 static
    # curl http://localhost:3000/static/index.html
    # proxy_pass 转发为 http://www.test.com/index.html
    proxy_pass http://www.test.com/; 

    #传 static
    # curl http://localhost:3000/static/index.html
    # proxy_pass 转发为 http://www.test.com/static/index.html
    proxy_pass http://www.test.com; 
}

location /forum {
    #http://node1.qiuyue.com/forum ->  http://192.168.1.144/bbs
    proxy_pass http://192.168.1.144/bbs;
    index index.html index.html;
}

#jpg、png或者gif结尾的请求反代
location ~* \.(jpg|png|gif)$ {
    proxy_pass http://192.168.1.144;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Nginx作为负载均衡服务"><a href="#Nginx作为负载均衡服务" class="headerlink" title="Nginx作为负载均衡服务"></a>Nginx作为负载均衡服务</h2><ul>
<li><a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html" target="_blank" rel="noopener">ngx_http_upstream_module</a></li>
</ul>
<p>按区域可分为GSLB，SLB </p>
<p>Example Configuration</p>
<pre class="line-numbers language-shell"><code class="language-shell">upstream backend {
    ip_hash; #调度方式 hash 
    server backend1.example.com   weight=5;
    server backend2.example.com:8080 max_fails=3 fail_timeout=30s;;
    server unix:/tmp/backend3 backup; 

    server backup1.example.com:8080   backup;
    server backup2.example.com:8080   backup;
}

server {
    location / {
        proxy_pass http://backend;

    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="调度算法"><a href="#调度算法" class="headerlink" title="调度算法"></a>调度算法</h3><p><img src="http://cdn.linz.tech/nginx_upstream.png" alt></p>
<p>ip_hash 有代理问题</p>
<pre class="line-numbers language-shell"><code class="language-shell">upstream imooc {
    hash $request_url; #可以提取URL指定位置进行hash
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h2 id="Nginx作为缓存服务"><a href="#Nginx作为缓存服务" class="headerlink" title="Nginx作为缓存服务"></a>Nginx作为缓存服务</h2><pre class="line-numbers language-shell"><code class="language-shell">proxy_cache_path /opt/app/cache levels=1:2 keys_zone=imooc_cache:10m max_size=10g inactive=7d max_size=10g use_temp_path=off;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>proxy_cache_path </p>
<p>keys_zone = 1m # 1m可以存储8000个</p>
<p>inactive = 60m# 60分钟内不访问就把他清除掉 </p>
<p>use_temp_path = off; #关闭零时文件存储，开启同时和 cache_path 使用可能会产生性能损耗</p>
<pre class="line-numbers language-shell"><code class="language-shell">location / {

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_cache imooc_cache;
    proxy_cache_valid 200 304 12h; #头部为返回为200 304 12小时过期
    proxy_cache_valid any 10m; #其他的10m过期
    proxy_cache_key $host$uri$is_args$args;
    add_header Nginx-Cache "&upstream_cache_status"; #查看缓存使用状态 Miss 未使用， HIT使用
    #当出现一下异常是启用下一个 upstream
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="清理指定缓存"><a href="#清理指定缓存" class="headerlink" title="清理指定缓存"></a>清理指定缓存</h3><p>ngx_cache_purge</p>
<p>安装ngx_cache_purge module块</p>
<pre class="line-numbers language-shell"><code class="language-shell">cd /tmp
wget http://labs.frickle.com/files/ngx_cache_purge-2.3.tar.gz
tar -xf ngx_cache_purge-2.3.tar.gz
dso_tool --add-module=/tmp/ngx_cache_purge-2.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>nginx.conf 配置</p>
<pre class="line-numbers language-shell"><code class="language-shell">dso {
    load ngx_cache_purge_module.so;
}

location ~ /purge(/.*) {
       allow 192.168.1.0/24;
       deny all;
       proxy_cache_purge mycache $host$1$is_args$args;
       access_log off;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>清理缓存</p>
<p>如果要清理<a href="http://node1.qiuyue.com/bbs/index.html的缓存，则访问http://node1.qiuyue.com/purge/bbs/index.html即" target="_blank" rel="noopener">http://node1.qiuyue.com/bbs/index.html的缓存，则访问http://node1.qiuyue.com/purge/bbs/index.html即</a></p>
<h3 id="让部分页面不缓存"><a href="#让部分页面不缓存" class="headerlink" title="让部分页面不缓存"></a>让部分页面不缓存</h3><pre class="line-numbers language-shell"><code class="language-shell">Systax: proxy_on_cache string ...
Context: http,server,location<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Sample</p>
<pre class="line-numbers language-shell"><code class="language-shell">server {
    #检测url是否已不缓存的页面
    if($request_url ~ ^/(url3|login|register|password\/reset)){ 
        set $cookie_nocache 1; #设置变量的值
    }

    location / {
        proxy_no_cache $cookie_nocache $arg_nocache $arg_comment;
        proxy_no_cache $http_pragma $http_authorization;
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="大文件分片请求"><a href="#大文件分片请求" class="headerlink" title="大文件分片请求"></a>大文件分片请求</h3><p>http_slice_module</p>
<pre class="line-numbers language-shell"><code class="language-shell">Systax: slice size;
Context: http,server,location<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>优势： </p>
<p>每个子请求收到的数据都会形成一个独立的文件，一个请求断了，其他请求不收影响</p>
<p>劣势：</p>
<p>当文件很大或者slice很小的时候，可能会导致文件描述符耗尽等情况</p>
<p>–with-http_slice_module</p>
<pre class="line-numbers language-shell"><code class="language-shell">http {
    include      mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    proxy_cache_path /tmp/nginx/cache levels=1:2 keys_zone=cache:100m;
    server {
        listen      8087;
        server_name  localhost;
        location / {
            slice 1m;
            proxy_cache cache;
            proxy_cache_key $uri$is_args$args$slice_range;
            proxy_set_header Range $slice_range;
            proxy_cache_valid 200 206 1h;
            #proxy_set_header Range $http_range;
            proxy_pass http://127.0.0.1:8080;
        }
        error_page  500 502 503 504  /50x.html;
        location = /50x.html {
            root  html;
        }

    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>该模块用在 proxy_cache 大文件的场景，将大文件切片缓存</li>
<li>编译时对 configure 加上 –with-http_slice_module 参数</li>
<li>$slice_range 一定要加到 proxy_cache_key 中，并使用 proxy_set_header 将其作为 Range 头传递给后端</li>
<li>要根据文件大小合理设置 slice 大小</li>
</ul>
<p>参考：<a href="https://www.cnblogs.com/chenpingzhao/p/5803772.html" target="_blank" rel="noopener">Nginx 切片模块、断点续传</a></p>
<h2 id="Nginx动静分离"><a href="#Nginx动静分离" class="headerlink" title="Nginx动静分离"></a>Nginx动静分离</h2><p>nginx分离JSP给Tomcat， jpg,png直接用静态资源</p>
<h2 id="Nginx-搭建文件服务器"><a href="#Nginx-搭建文件服务器" class="headerlink" title="Nginx 搭建文件服务器"></a>Nginx 搭建文件服务器</h2><h1 id="第四章-深度学习篇"><a href="#第四章-深度学习篇" class="headerlink" title="第四章 深度学习篇"></a>第四章 深度学习篇</h1><h2 id="Nginx简单的语法"><a href="#Nginx简单的语法" class="headerlink" title="Nginx简单的语法"></a>Nginx简单的语法</h2><h3 id="Nginx-变量-1"><a href="#Nginx-变量-1" class="headerlink" title="Nginx 变量"></a>Nginx 变量</h3><blockquote>
<ol>
<li>Nginx 变量名的可见范围虽然是整个配置，但每个请求都有所有变量的独立副本，或者说都有各变量用来存放值的容器的独立副本，彼此互不干扰;</li>
<li>一个请求在其处理过程中，即使经历多个不同的 <code>location</code> 配置块，它使用的还是同一套 Nginx 变量的副本,Nginx 变量值容器的生命期是与当前正在处理的请求绑定的，而与 <code>location</code>无关。</li>
</ol>
</blockquote>
<ol>
<li><p>Nginx 内建变变量  <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#Embedded%20Variables" target="_blank" rel="noopener">Embedded Variables</a> ， 有由 Nginx 核心和各个 Nginx 模块提供的“预定义变量”，或者说“内建变量”（builtin variables）。常用的内键变量请查看附录二，Nginx全局变量解析</p>
</li>
<li><p><a href="http://wiki.nginx.org/HttpCoreModule#.24arg_PARAMETER" target="_blank" rel="noopener">$arg_XXX</a> 变量群，大部分arg_xxx变量是只读的，尝试修改会报一些奇特的异常<br>$arg_name 案例</p>
<pre class="line-numbers language-shell"><code class="language-shell">location /test {
       echo "name: $arg_name";
       echo "class: $arg_class";
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>请求/test接口</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ curl 'http://localhost:8080/test'
name: 
class: 

$ curl 'http://localhost:8080/test?name=Tom&class=3'
name: Tom
class: 3

$ curl 'http://localhost:8080/test?name=hello%20world&class=9'
name: hello%20world
class: 9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>$arg_name</code> 不仅可以匹配 <code>name</code> 参数，也可以匹配 <code>NAME</code> 参数，抑或是 <code>Name</code>，等等</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ curl 'http://localhost:8080/test?NAME=Marry'
name: Marry
class: 

$ curl 'http://localhost:8080/test?Name=Jimmy'
name: Jimmy
class:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对<code>hello%20world</code>进行解码,使用第三方 <a href="http://wiki.nginx.org/HttpSetMiscModule" target="_blank" rel="noopener">ngx_set_misc</a> 模块提供</p>
<pre class="line-numbers language-shell"><code class="language-shell">   location /test {
       set_unescape_uri $name $arg_name;
       set_unescape_uri $class $arg_class;

       echo "name: $name";
       echo "class: $class";
   }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试效果</p>
<pre class="line-numbers language-shell"><code class="language-shell">$ curl 'http://localhost:8080/test?name=hello%20world&class=9'
name: hello world
class: 9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>类 <a href="http://wiki.nginx.org/HttpCoreModule#.24arg_PARAMETER" target="_blank" rel="noopener">$arg_XXX</a> 的内建变量群，比如用来取 cookie 值的 <a href="http://wiki.nginx.org/HttpCoreModule#.24cookie_COOKIE" target="_blank" rel="noopener">$cookie_XXX</a> 变量群，用来取请求头的 <a href="http://wiki.nginx.org/HttpCoreModule#.24http_HEADER" target="_blank" rel="noopener">$http_XXX</a> 变量群，以及用来取响应头的 <a href="http://wiki.nginx.org/HttpCoreModule#.24sent_http_HEADER" target="_blank" rel="noopener">$sent_http_XXX</a> 变量群，参考 <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html" target="_blank" rel="noopener">ngx_http_core</a> 模块的官方文档。</p>
</li>
</ol>
<h3 id="Perl兼容正则表达式"><a href="#Perl兼容正则表达式" class="headerlink" title="Perl兼容正则表达式"></a>Perl兼容正则表达式</h3><ul>
<li>.：匹配除换行符\n以外的任意单个字符</li>
<li>?：匹配之前的字符0次或1次</li>
<li>+：匹配之前的字符至少1次</li>
<li>*：匹配之前的字符任意次</li>
<li>\d：匹配数字</li>
<li>^：匹配字符串的开始</li>
<li>$：匹配字符串的结尾</li>
<li>{m}：重复m次</li>
<li>{m,}：重复至少m次</li>
<li>{m,n}：重复至少m次，最多n次</li>
<li>[a]：匹配单个字符a</li>
<li>[a-z]：匹配a-z小写字母中的任意一个</li>
<li>[^ ]：匹配任何不包括在指定字符集内的任意字符</li>
<li>|：匹配 | 之前或之后的部分</li>
<li>()：分组，组成一组用于匹配的实体，通常配合 | 使用。小括号()之间匹配的内容，可以在后面通过$1来引用，$2表示的是前面第二个()里的内容</li>
</ul>
<p>深入学习参考 <a href="http://deerchao.net/tutorials/regex/regex.htm" target="_blank" rel="noopener">正则表达式30分钟入门教程</a></p>
<pre class="line-numbers language-shell"><code class="language-shell">#localhost:8080/abc/qwe/asd
location ~/abc/(.*)/(.*) {
    set $para1 $1; # qwe
    set $para2 $2;# asd
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><code>$1|$2|$3 ...</code>是<code>nginx在匹配正则时生成的变量</code>，用于捕获<strong>一个</strong>正则表达式括号中匹配的字符串（从左到右依次存储在<code>$1|$2|$3 ...</code>中），新值覆盖旧值。</p>
</blockquote>
<p><code>if(条件) {…}</code></p>
<ol>
<li>if(b), b是空或者任务以0开头的字符串，条件为false</li>
<li>比较内容，用= 或!= </li>
<li>检测文件或目录<ol>
<li>-f和!-f用来判断文件是否存在</li>
<li>-d和!-d用来判断目录是否存在</li>
<li>-e和!-e用来判断文件和目录是否存在</li>
<li>-x和!-x用来判断文件是否可执行</li>
</ol>
</li>
</ol>
<pre class="line-numbers language-shell"><code class="language-shell">if(!-f $request_filename){ #如果文件不存在重定向到百度
    rewrite ^/(.*)$ http://www.baidu.com/$1 redirect;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>正则表达式匹配：</p>
<p>==:等值比较;</p>
<p>~：与指定正则表达式模式匹配时返回“真”，判断匹配与否时区分字符大小写；</p>
<p>~*：与指定正则表达式模式匹配时返回“真”，判断匹配与否时不区分字符大小写；</p>
<p>!~：与指定正则表达式模式</p>
<p>不匹配时返回“真”，判断匹配与否时区分字符大小写；</p>
<p>!~*：与指定正则表达式模式不匹配时返回“真”，判断匹配与否时不区分字符大小写；</p>
<h3 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h3><p><strong>浏览器实现分离</strong></p>
<pre class="line-numbers language-shell"><code class="language-shell"># 禁止使用curl命令下载文件
if ($http_user_agent ~ curl) {
    return 403;
}

# 浏览器实现分离
if ($http_user_agent ~ Firefox){
       rewrite ^/(.*)$ /firefox/$1 break;
}

if ($http_user_agent ~ MSIE){
      rewrite ^/(.*)$ /msie/$1 break;
}

if ($http_user_agent ~ Edge){
      rewrite ^/(.*)$ /edge/$1 break;
}

if ($http_user_agent ~ Chrome){
      rewrite ^/(.*)$ /chrome/$1 break;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>浏览器分离的效果</p>
<pre class="line-numbers language-shell"><code class="language-shell">例如： 用chrome访问 http://192.168.1.222/index.html 会访问 /usr/local/tengine/html/chrome/index.html

# echo "Firefox html" > /usr/local/tengine/html/firefox/index.html
# echo "MSIE html" > /usr/local/tengine/html/msie/index.html
# echo "Edge html" > /usr/local/tengine/html/edge/index.html
# echo "Chrome html" > /usr/local/tengine/html/chrome/index.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>网站更新，原服务跳转到停服提示，公司内部IP可以访问</p>
<pre class="line-numbers language-shell"><code class="language-shell">set $my_ip ''; 
if ( $remote_addr = 222.222.222.222){set $my_ip 1;} #注意这里的$remote_addr如何用了负载均衡的话,这里应该是$http_x_forwarded_for
if ( $remote_addr = 192.168.1.170 ){ set $my_ip 1;}
if ( $remote_addr = 192.168.1.169 ){ set $my_ip 1;}
if ( $my_ip != 1) {rewrite ^/design/(.*)\.php$ /tingfu.html?$1&;}  #将*.php转到tingfu.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>只允许指定IP访问，其他IP跳转到指定页面</p>
<pre class="line-numbers language-shell"><code class="language-shell">set $test '';
if ( $request_uri ~* /img/test.php ) {
        set $test P;
}

if ( $http_x_forwarded_for !~* ^222\.222\.222\.222.* ) {
        set $test "${test}C";
}

if ( $test = PC ) {  #当条件符合 访问test.php并且 ip不是222.222.222.222的 转发到55555.php
    rewrite ^(.*)$ /img/55555.php permanent;  
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Location使用详解"><a href="#Location使用详解" class="headerlink" title="Location使用详解"></a>Location使用详解</h2><blockquote>
<p>参考 <a href="https://www.cnblogs.com/xiaoliangup/p/9175932.html" target="_blank" rel="noopener">nginx location指令详解</a></p>
</blockquote>
<p>基本语法： <code>location [=|~|~\*|^~|@] pattern{……}**</code></p>
<ol>
<li>没有修饰符 表示：必须以指定模式开始</li>
<li>=表示：必须与指定的模式<code>精确</code>匹配</li>
<li>~ 表示：指定的正则表达式要<code>区分大小写</code><ul>
<li><code>~ \.(txt|css)$</code>   匹配所有以txt和css结尾的请求 区分大小写</li>
</ul>
</li>
<li>~* 表示：指定的正则表达式<code>不区分大小写</code></li>
<li>^~ 类似于无修饰符的行为，也是以指定模式开始，不同的是，如果模式匹配，<br>那么就<code>停止搜索其他模式</code>了。</li>
<li>@ ：定义命名location区段，这些区段客户段不能访问，只可以由<code>内部</code>产生的请<br>求来访问，如try_files或error_page等</li>
</ol>
<p>优先级 “=” &gt; <strong>“^~”</strong> &gt; *<em>“<del>” 或“</del>\</em>” ** &gt; “/ ”</p>
<ol>
<li>location块中未设置root时，会取外层（server块）的root，但server.root明显不是先生成字符串然后赋值给location.root，而是直接把模板串交给location.root。</li>
</ol>
<h2 id="Rewrite规则"><a href="#Rewrite规则" class="headerlink" title="Rewrite规则"></a>Rewrite规则</h2><blockquote>
<p><a href="https://blog.51cto.com/qiuyue/2121319" target="_blank" rel="noopener">CentOS 7.4 Tengine安装配置详解（四）</a></p>
</blockquote>
<p>配置语法</p>
<pre class="line-numbers language-shell"><code class="language-shell">Syntax: rewrite regex replacement [falg];
Context: server, location , if<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="四种flag标志位"><a href="#四种flag标志位" class="headerlink" title="四种flag标志位"></a>四种flag标志位</h3><ul>
<li>last：执行该rewrite规则后，停止处理后续的rewrite指令集，对于<code>重写后的URL会重新匹配location</code></li>
<li>break：执行该rewrite规则后，停止处理后续的rewrite指令集，<code>不再进行location匹配</code></li>
<li>redirect：重写完成之后会返回客户端302状态响应码（临时重定向），地址栏会显示跳转后的地址</li>
<li>permanent：重写完成之后会返回客户端301（永久重定向），地址栏会显示跳转后的地址</li>
</ul>
<p>Sample01 <code>default</code></p>
<pre class="line-numbers language-shell"><code class="language-shell">location /aaa.html {
    rewrite "^/aaa.html$" /bbb.html; # 先走rewrite 才 location
    rewrite "^/bbb.html$" /ddd.html;
}


location /bbb.html {
    rewrite "^/bbb.html$" /ccc.html;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建测试内容：</p>
<pre class="line-numbers language-shell"><code class="language-shell"># echo "aaa html" > /usr/local/tengine/html/aaa.html
# echo "bbb html" > /usr/local/tengine/html/bbb.html
# echo "ccc html" > /usr/local/tengine/html/ccc.html
# echo "ddd html" > /usr/local/tengine/html/ddd.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试结果</p>
<blockquote>
<p> curl <a href="http://localhost/aaa.html" target="_blank" rel="noopener">http://localhost/aaa.html</a> –&gt; ddd.html</p>
</blockquote>
<p> Sample02  <code>last</code></p>
<pre class="line-numbers language-shell"><code class="language-shell">location /aaa.html {

    rewrite "^/aaa.html$" /bbb.html last; # 不会往下rewrite ,走下面的location匹配
    rewrite "^/bbb.html$" /ddd.html; 

}

location /bbb.html {
    rewrite "^/bbb.html$" /ccc.html;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>测试： curl <a href="http://localhost/aaa.html" target="_blank" rel="noopener">http://localhost/aaa.html</a> ==&gt; ccc.html</p>
<p>解析： aaa.html –&gt; bbb.html –&gt; 由于flag为last，所以不会将bbb.html –&gt; ddd.html –&gt; 重新匹配bbb.html –&gt; ccc.html</p>
</blockquote>
<p>Sample03  <code>break</code></p>
<pre class="line-numbers language-shell"><code class="language-shell">location /aaa.html {
    rewrite "^/aaa.html$" /bbb.html break;  # 不向下rewrite 及location
    rewrite "^/bbb.html$" /ddd.html;
}

location /bbb.html {
    rewrite "^/bbb.html$" /ccc.html;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>测试： curl <a href="http://localhost/aaa.html" target="_blank" rel="noopener">http://localhost/aaa.html</a> –&gt; bbb.html</p>
<p>解析：aaa.html –&gt; bbb.html –&gt; 由于flag为break，所以不再进行location匹配</p>
</blockquote>
<p>Sample04 首先执行server段内的rewrite指令</p>
<pre class="line-numbers language-shell"><code class="language-shell">rewrite "^/aaa.html$" /bbb.html;

location /ccc.html {
    rewrite "^/ccc.html$" /eee.html;
}

location /bbb.html {
    rewrite "^/bbb.html$" /ccc.html;
    rewrite "^/ccc.html$" /ddd.html;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p> curl <a href="http://localhost/aaa.html" target="_blank" rel="noopener">http://localhost/aaa.html</a> –&gt; ddd.html</p>
</blockquote>
<p>Sample 05 先把server段的rewrite弄完，然后才location</p>
<pre class="line-numbers language-shell"><code class="language-shell">rewrite "^/aaa.html$" /bbb.html;

rewrite "^/ccc.html$" /ddd.html;


location /bbb.html {
    rewrite "^/bbb.html$" /ccc.html;
}

location /ddd.html {
    rewrite "^/ddd.html$" /eee.html;
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>测试： curl <a href="http://localhost/aaa.html" target="_blank" rel="noopener">http://localhost/aaa.html</a> –&gt; ccc.html</p>
</blockquote>
<h3 id="实战案例-1"><a href="#实战案例-1" class="headerlink" title="实战案例"></a>实战案例</h3><p>浏览器分离</p>
<pre class="line-numbers language-shell"><code class="language-shell">#http://192.168.1.222/index.html  -> /usr/local/tengine/html/msie/index.html
if ($http_user_agent ~ MSIE){

      rewrite ^/(.*)$ /msie/$1 break;

}
#http://192.168.1.222/index.html  -> /usr/local/tengine/html/edge/index.html
if ($http_user_agent ~ Edge){

      rewrite ^/(.*)$ /edge/$1 break;

}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>自动跳转到, <a href="http://blog.qiuyue.com时自动跳转到http://www.qiuyue.com/blog" target="_blank" rel="noopener">http://blog.qiuyue.com时自动跳转到http://www.qiuyue.com/blog</a></p>
<pre class="line-numbers language-shell"><code class="language-shell">server {

    listen 80;
    server_name blog.qiuyue.com;
    rewrite ^/(.*)$ http://www.qiuyue.com/blog/$1 permanent;

    location / {
         root html/blog;
         index index.html index.html;
    }
}

server {
    listen 80;
    server_name www.qiuyue.com;
    location / {
      root html/www;
      index index.html index.html;
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><a href="http://www.qiuyue.com/bbs时自动跳转到http://bbs.qiuyue.com" target="_blank" rel="noopener">http://www.qiuyue.com/bbs时自动跳转到http://bbs.qiuyue.com</a></p>
<pre class="line-numbers language-shell"><code class="language-shell">server {

    listen 80;
    server_name www.qiuyue.com;
    rewrite ^/bbs/(.*)$ http://bbs.qiuyue.com/$1 permanent;

     location / {
        root html/www;
        index index.html index.html;
     }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="优雅的Rewrite规则书写"><a href="#优雅的Rewrite规则书写" class="headerlink" title="优雅的Rewrite规则书写"></a>优雅的Rewrite规则书写</h3><p>自己写的</p>
<pre class="line-numbers language-shell"><code class="language-shell">server {
    listen 80;
    server_name www.nginx.org nginx.org;
    if($htpp_host = nginx.org){
        rewrite (.*) http://www.nginx.org$1;
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>官方推荐写法</p>
<pre class="line-numbers language-shell"><code class="language-shell">server {
    listen 80;
    server_name nginx.org;
    rewrite ^ http://www.nginx.org$request_url?; #只用一行，并且书写美观
}

server {
    listen 80;
    server_name www.nginx.org;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Nginx-高级模块"><a href="#Nginx-高级模块" class="headerlink" title="Nginx 高级模块"></a>Nginx 高级模块</h2><h3 id="secure-link-module模块"><a href="#secure-link-module模块" class="headerlink" title="secure_link_module模块"></a>secure_link_module模块</h3><ul>
<li><a href="https://nginx.org/en/docs/http/ngx_http_secure_link_module.html" target="_blank" rel="noopener">ngx_http_secure_link_module</a></li>
</ul>
<p>注意作用：</p>
<ol>
<li>制定并允许检查请求的连接的真实性以及保护资源免遭未经授权的访问；</li>
<li>限制连接生效周期；</li>
</ol>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>enabled with the <code>--with-http_secure_link_module</code></p>
<p>语法</p>
<pre class="line-numbers language-shell"><code class="language-shell">Syntax:    secure_link expression;
Context:    http, server, location<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-shell"><code class="language-shell">Syntax:    secure_link_md5 expression;
Context:    http, server, location<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h4><pre class="line-numbers language-shell"><code class="language-shell">location /s/ {
    secure_link $arg_md5,$arg_expires;
    secure_link_md5 "$secure_link_expires$uri$remote_addr secret";

    if ($secure_link = "") {
        return 403;
    }

    if ($secure_link = "0") {
        return 410;
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>md5url.sh 生成安全连接</p>
<pre class="line-numbers language-shell"><code class="language-shell">#!/bin/sh
#
#Auth:zhilinchn@126.com
servername="zhilinchn.com"
download_file="/dowload/file.img"
time_num=$(date -d "2019-10-16 00:00:00" +%s)
secret_num="secret"  #记得和服务端 secret对应
res=$(echo -n "${time_num}${download_file} ${secret_num}" | openssl md5 -binary | openssl base64 | tr +/ -_ | tr -d =)
echo "http://${servername}${download_file}?md5=${res}&expires=${time_num}"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>source md5url.sh 进行访问</p>
<pre class="line-numbers language-shell"><code class="language-shell">http://zhilinchn.com/dowload/file.img?md5=FFhZt0XJo7ed_X973FsRgA&expires=1571155200<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="geoip-module-模块"><a href="#geoip-module-模块" class="headerlink" title="geoip_module 模块"></a>geoip_module 模块</h3><ul>
<li><a href="https://nginx.org/en/docs/http/ngx_http_geoip_module.html" target="_blank" rel="noopener">ngx_http_geoip_module</a> 基于IP地址MaxMind GeoIP 二进制文件，读取IP所在地域信息。</li>
<li>yum install nginx-module-geoip</li>
</ul>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><ol>
<li>区别国内国外作HTTP访问规则</li>
<li>区别国内城市地域HTTP访问规则</li>
</ol>
<h3 id="ngx-fancyindex-实现文件索引目录"><a href="#ngx-fancyindex-实现文件索引目录" class="headerlink" title="ngx-fancyindex 实现文件索引目录"></a>ngx-fancyindex 实现文件索引目录</h3><blockquote>
<p>实现索引目录（适用于下载站）tengine</p>
</blockquote>
<ol>
<li><p>下载ngx-fancyindex</p>
<pre class="line-numbers language-shell"><code class="language-shell">yum -y install git \
cd /tmp \
git clone https://github.com/aperezdc/ngx-fancyindex.git ngx-fancyindex<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>使用Tengine的dso_tool工具编译第三方模块：</p>
<pre class="line-numbers language-shell"><code class="language-shell">dso_tool -h #help
dso_tool --add-module=/tmp/ngx-fancyindex
ls /usr/local/tengine/modules | grep fancyindex  -->  ngx_http_fancyindex_module.so<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>添加events 配置</p>
</li>
</ol>
<pre class="line-numbers language-shell"><code class="language-shell">   dso {
       load ngx_http_fancyindex_module.so;
   }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li><p>server 设置</p>
<pre class="line-numbers language-shell"><code class="language-shell">location /software {
    root /download;
    fancyindex on;              # 启用fancy目录索引功能
    fancyindex_exact_size off;    # 不显示文件的精确大小，而是四舍五入，单位是KB、MB和GB
    fancyindex_localtime on;     # 默认为off，显示的是GMT时间，改为on，显示的是服务器时间

}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>重载后测试</p>
</li>
</ol>
<ul>
<li>访问到测试</li>
<li>检测模块是否加载成功 nginx -m  –&gt;  ngx_http_fancyindex_module (shared, 3.1)</li>
</ul>
<h2 id="基于Nginx的HTTPS服务"><a href="#基于Nginx的HTTPS服务" class="headerlink" title="基于Nginx的HTTPS服务"></a>基于Nginx的HTTPS服务</h2><h3 id="自建CA服务器创建私有CA"><a href="#自建CA服务器创建私有CA" class="headerlink" title="自建CA服务器创建私有CA"></a>自建CA服务器创建私有CA</h3><ol>
<li><p>安装相关软件包,生成私钥</p>
<pre class="line-numbers language-shell"><code class="language-shell">yum -y install openssl openssh-clients
#创建保存证书信息的数据库文件
touch /etc/pki/CA/index.txt
#保存证书序列号的文件
echo 01 > /etc/pki/CA/serial
#生成私钥cakey.pem
(umask 077; openssl genrsa -out /etc/pki/CA/private/cakey.pem 2048)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>备注：</p>
<p>genrsa：用于生成RSA密钥对的OpenSSL子命令 (man genrsa)</p>
<p>-out cakey.pem 指定私钥保存位置</p>
<p>2048 密钥长度</p>
</li>
<li><p>生成CA证书cacert.pem</p>
<pre class="line-numbers language-shell"><code class="language-shell">cd /etc/pki/CA 
openssl req -new -x509 -key private/cakey.pem -days 7300 -out cacert.pem<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>输入信息</p>
<pre class="line-numbers language-shell"><code class="language-shell">Country Name (2 letter code) [XX]:cn
State or Province Name (full name) []:guangdong       
Locality Name (eg, city) [Default City]:shenzhen
Organization Name (eg, company) [Default Company Ltd]:TX
Organizational Unit Name (eg, section) []:DEV
Common Name (eg, your name or your server's hostname) []:ca.vhosts.com #证书颁发者
Email Address []:zhilinchn@126.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>备注：</p>
<p>req子命令常用选项（man req）<br>-new：生成新证书签署请求<br>-x509：专用于CA生成自签证书<br>-key cakey.pem：生成CA证书请求时用到的私钥</p>
<p>-days 7300：证书的有效期限为20年<br>-out cacert.pem：证书的保存路径</p>
</li>
</ol>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://blog.csdn.net/baofeidyz/article/details/80435929" target="_blank" rel="noopener">【Nginx】Nginx配置SSL证书</a></li>
</ul>
<h2 id="Nginx-与Lua开发"><a href="#Nginx-与Lua开发" class="headerlink" title="Nginx 与Lua开发"></a>Nginx 与Lua开发</h2><h3 id="Nginx与Lua特性与优势"><a href="#Nginx与Lua特性与优势" class="headerlink" title="Nginx与Lua特性与优势"></a>Nginx与Lua特性与优势</h3><ol>
<li><p>Lua 是一个简洁、轻量、可扩展的脚本语言。Lua脚本可以很容易的被<a href="https://baike.baidu.com/item/C%2FC%2B%2B" target="_blank" rel="noopener">C/C++</a> 代码调用，也可以反过来调用C/C++的函数。Lua由标准C编写而成，代码简洁优美，几乎在所有操作系统和平台上都可以<a href="https://baike.baidu.com/item/编译/1258343" target="_blank" rel="noopener">编译</a>，运行。一个完整的Lua解释器不过200k，在目前所有<a href="https://baike.baidu.com/item/脚本引擎/4449478" target="_blank" rel="noopener">脚本引擎</a>中，Lua的速度是最快的。这一切都决定了Lua是作为嵌入式脚本的最佳选择</p>
</li>
<li><p>Nginx+ Lua的优势<br>充分结合Nginx的并发处理epoll优势和Lua的轻量级实现简单的功能提高高并发场景。</p>
<ul>
<li>统计用户IP；</li>
<li>统计用户的访问次数；</li>
<li>安全功能</li>
</ul>
</li>
</ol>
<h3 id="Lua-基础语法"><a href="#Lua-基础语法" class="headerlink" title="Lua 基础语法"></a>Lua 基础语法</h3><ol>
<li><p>安装lua解析器 <code>yum install lua</code></p>
</li>
<li><p>run Hello World </p>
<ul>
<li><p>terminal input lua <code>print(&quot;Hello World!&quot;)</code></p>
</li>
<li><p>script：test.lua , <code>chmod a+x text.lua</code> <code>./test.lua</code></p>
<pre class="line-numbers language-shell"><code class="language-shell">#!/usr/bin/lua
print("Hello World!")<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>注释</p>
<pre class="line-numbers language-shell"><code class="language-shell">-- 单行注释
--[[
 多行注释
 多行注释
 --]]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>lua的数据类型<br>布尔类型只有nil和false， 数字，空字符串（’\0‘）都是true</p>
</li>
<li><p>变量</p>
<pre class="line-numbers language-lua"><code class="language-lua">a <span class="token operator">=</span> <span class="token number">5</span>               <span class="token comment" spellcheck="true">-- 全局变量</span>
<span class="token keyword">local</span> b <span class="token operator">=</span> <span class="token number">5</span>         <span class="token comment" spellcheck="true">-- 局部变量</span>

<span class="token keyword">function</span> <span class="token function">joke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    c <span class="token operator">=</span> <span class="token number">5</span>           <span class="token comment" spellcheck="true">-- 全局变量</span>
    <span class="token keyword">local</span> d <span class="token operator">=</span> <span class="token number">6</span>     <span class="token comment" spellcheck="true">-- 局部变量</span>
<span class="token keyword">end</span>

<span class="token function">joke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>d<span class="token punctuation">)</span>          <span class="token comment" spellcheck="true">--> 5 nil</span>

<span class="token keyword">do</span> 
    <span class="token keyword">local</span> a <span class="token operator">=</span> <span class="token number">6</span>     <span class="token comment" spellcheck="true">-- 局部变量</span>
    b <span class="token operator">=</span> <span class="token number">6</span>           <span class="token comment" spellcheck="true">-- 对局部变量重新赋值</span>
    <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">--> 6 6</span>
<span class="token keyword">end</span>

<span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span>      <span class="token comment" spellcheck="true">--> 5 6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<p>while循环</p>
<pre class="line-numbers language-lua"><code class="language-lua">sum <span class="token operator">=</span> <span class="token number">0</span> 
num <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">while</span> num <span class="token operator">&lt;=</span><span class="token number">100</span> <span class="token keyword">do</span>
    sum <span class="token operator">=</span> sum <span class="token operator">+</span> num
    <span class="token comment" spellcheck="true">-- 不支持 num++</span>
    num <span class="token operator">=</span> num <span class="token operator">+</span><span class="token number">1</span>
<span class="token keyword">end</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"sum="</span><span class="token punctuation">,</span>sum<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>for循环</p>
<pre class="line-numbers language-shell"><code class="language-shell">sum=0
for i=1,100 do
    sum = sum +i
end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>if-else 判断语句</p>
<pre class="line-numbers language-lua"><code class="language-lua"><span class="token keyword">if</span> age <span class="token operator">==</span> <span class="token number">40</span> <span class="token keyword">and</span> sex <span class="token operator">==</span> <span class="token string">"Male"</span> <span class="token keyword">then</span> 
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"大于40男人"</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">-- ~= 不等于</span>
<span class="token keyword">elseif</span> age <span class="token operator">></span> <span class="token number">60</span> <span class="token keyword">and</span> sex <span class="token operator">~=</span> <span class="token string">"Female"</span> <span class="token keyword">then</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"非女人而且大于60"</span><span class="token punctuation">)</span>
<span class="token keyword">else</span>
    <span class="token comment" spellcheck="true">-- 从屏幕终端读取</span>
    <span class="token keyword">local</span> age <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">-- .. 字符拼接</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Your age is "</span><span class="token operator">..</span>age<span class="token punctuation">)</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Nginx-lua-环境"><a href="#Nginx-lua-环境" class="headerlink" title="Nginx + lua 环境"></a>Nginx + lua 环境</h3><ol>
<li><p>LuaJIT</p>
</li>
<li><p>ngx_devel_kit 和lua-nginx-module</p>
</li>
<li><p>重新编译 参考 <a href="http://www.imooc.com/article/19597" target="_blank" rel="noopener">http://www.imooc.com/article/19597</a> </p>
</li>
<li><p>容器化，参考附录二</p>
</li>
</ol>
<h3 id="Nginx-调用lua模块指令"><a href="#Nginx-调用lua模块指令" class="headerlink" title="Nginx 调用lua模块指令"></a>Nginx 调用lua模块指令</h3><p><img src="http://cdn.linz.tech/nginx_lua_module.png" alt></p>
<h3 id="Nginx-lua-API"><a href="#Nginx-lua-API" class="headerlink" title="Nginx lua API"></a>Nginx lua API</h3><p><img src="http://cdn.linz.tech/nginx_lua_api.png" alt></p>
<p>比较全的API总结 <a href="https://www.cnblogs.com/wangxusummer/p/4309007.html" target="_blank" rel="noopener">ngx_lua 模块</a></p>
<pre class="line-numbers language-shell"><code class="language-shell">location /hello {
      default_type 'text/plain';
      content_by_lua 'ngx.say("hello, lua")';
}

location /myip {
      default_type 'text/plain';
      content_by_lua 'ngx.req.get_headers()["x_forward_for"] ngx.say("IP",clientIP)'
}

location / {
      default_type 'text/plain';
      content_by_lua_file0 /opt/app/lua/dep.lua; #调用lua脚本
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="实战-灰度发布"><a href="#实战-灰度发布" class="headerlink" title="实战-灰度发布"></a>实战-灰度发布</h3><p><a href="https://blog.csdn.net/qq_31725371/article/details/85226056#2_192168120MemcacheLua_70" target="_blank" rel="noopener">Nginx + Lua + Memcache基于IP实现灰度发布</a></p>
<p>dep.lua</p>
<pre class="line-numbers language-lua"><code class="language-lua"><span class="token comment" spellcheck="true">-- 取到用户IP</span>
clientIP <span class="token operator">=</span> ngx<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">get_headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"X-Real-IP"</span><span class="token punctuation">]</span>
<span class="token keyword">if</span> clientIP <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
    clientIP <span class="token operator">=</span> ngx<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">get_headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"x_forwarded_for"</span><span class="token punctuation">]</span>
<span class="token keyword">end</span>
<span class="token keyword">if</span> clientIP <span class="token operator">==</span> nill <span class="token keyword">then</span> 
    clientIP <span class="token operator">==</span> ngx<span class="token punctuation">.</span>var<span class="token punctuation">.</span>remote_addr
<span class="token keyword">end</span>
    <span class="token keyword">local</span> memcached <span class="token operator">=</span> require <span class="token string">"resty.memcached"</span>
    <span class="token keyword">local</span> memc<span class="token punctuation">,</span> err <span class="token operator">=</span> memcached<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> memc <span class="token keyword">then</span> 
        ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token string">"failed to instantiate memc:"</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token keyword">end</span>
    <span class="token keyword">local</span> ok<span class="token punctuation">,</span>err <span class="token operator">=</span> memc<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span><span class="token number">11211</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> ok <span class="token keyword">then</span> 
        ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token string">"failed to connect:"</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token keyword">end</span>
    <span class="token keyword">local</span> res<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> err <span class="token operator">=</span> memc<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span>clientIP<span class="token punctuation">)</span>
    ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token string">"value key:"</span><span class="token punctuation">,</span>res<span class="token punctuation">,</span>clientIP<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token keyword">then</span> 
        ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token string">"failed to get clientIP "</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">return</span> 
    <span class="token keyword">end</span> 
    <span class="token keyword">if</span> res <span class="token operator">==</span> <span class="token string">"1"</span> <span class="token keyword">then</span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="第五章-Nginx架构篇"><a href="#第五章-Nginx架构篇" class="headerlink" title="第五章 Nginx架构篇"></a>第五章 Nginx架构篇</h1><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><ol>
<li>多个server_name 的优先级</li>
<li>多个Location优先级</li>
<li>try_files使用</li>
<li>alias 和root区别</li>
<li>获取用户真实IP</li>
<li>Nginx常见的错误</li>
</ol>
<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><h3 id="Apache-ab-压测试工具"><a href="#Apache-ab-压测试工具" class="headerlink" title="Apache ab 压测试工具"></a>Apache ab 压测试工具</h3><p>安装</p>
<pre class="line-numbers language-shell"><code class="language-shell">sudo yum install httpd-tools<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>使用</p>
<pre class="line-numbers language-shell"><code class="language-shell"># -n 发送100次 -c 并发10
ab -n 100 -c 10 [http[s]://]hostname[:port]/path
#-p post 方式 -T 数据格式
#post_wecaht.txt  = {"send_type":"email", "to":"yanyongwen@xiaoniu66.com", "content":"parallel test"}
ab -n 100 -c 10 -p post_wechat.txt -T application/json [http[s]://]hostname[:port]/path
#-H headers
ab -n 1000 -c 200 -p post.txt -H 'X-Custom-Header':'xxxx' -H 'OS-TYPE':'linux' -T application/json http://localhost:9090/hardware
# -k 是否开启长连接<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结果分析</p>
<pre class="line-numbers language-shell"><code class="language-shell">Server Software:        Microsoft-HTTPAPI/2.0 
Server Hostname:        192.168.0.10 
Server Port:            80

Document Path:          / 
Document Length:        315 bytes       HTTP响应数据的正文长度

Concurrency Level:      800 
Time taken for tests:   0.914 seconds    所有这些请求处理完成所花费的时间 
Complete requests:      800             完成请求数 
Failed requests:        0                失败请求数 
Write errors:           0                
Non-2xx responses:      800              # 有多少个非200的请求
Total transferred:      393600 bytes     网络总传输量 
HTML transferred:       252000 bytes     HTML内容传输量 
Requests per second:    875.22 [#/sec] (mean) 吞吐量-每秒请求数 
Time per request:       914.052 [ms] (mean)  服务器收到请求，响应页面要花费的时间 
Time per request:       1.143 [ms] (mean, across all concurrent requests) 并发的每个请求平均消耗时间 
Transfer rate:          420.52 [Kbytes/sec] received 平均每秒网络上的流量，可以帮助排除是否存在网络流量过大导致响应时间延长的问题


网络上消耗的时间的分解： 
Connection Times (ms) 
              min  mean[+/-sd] median   max 
Connect:        0    1   0.5      1       3 
Processing:   245  534 125.2    570     682 
Waiting:       11  386 189.1    409     669 
Total:        246  535 125.0    571     684

整个场景中所有请求的响应情况。在场景中每个请求都有一个响应时间 
其中 50％ 的用户响应时间小于 571 毫秒 
80 ％ 的用户响应时间小于 652 毫秒 
最大的响应时间小于 684 毫秒 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="系统和Nginx性能优化"><a href="#系统和Nginx性能优化" class="headerlink" title="系统和Nginx性能优化"></a>系统和Nginx性能优化</h3><h3 id="文件句柄设置"><a href="#文件句柄设置" class="headerlink" title="文件句柄设置"></a>文件句柄设置</h3><h3 id="CPU亲和性设置"><a href="#CPU亲和性设置" class="headerlink" title="CPU亲和性设置"></a>CPU亲和性设置</h3><h3 id="Nginx通用配置优化"><a href="#Nginx通用配置优化" class="headerlink" title="Nginx通用配置优化"></a>Nginx通用配置优化</h3><h2 id="Nginx安全"><a href="#Nginx安全" class="headerlink" title="Nginx安全"></a>Nginx安全</h2><h3 id="恶意行为控制手段"><a href="#恶意行为控制手段" class="headerlink" title="恶意行为控制手段"></a>恶意行为控制手段</h3><h3 id="攻击手段之暴力破解"><a href="#攻击手段之暴力破解" class="headerlink" title="攻击手段之暴力破解"></a>攻击手段之暴力破解</h3><h3 id="文件上传漏洞"><a href="#文件上传漏洞" class="headerlink" title="文件上传漏洞"></a>文件上传漏洞</h3><h3 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h3><h3 id="Nginx-lua-防火墙功能"><a href="#Nginx-lua-防火墙功能" class="headerlink" title="Nginx + lua 防火墙功能"></a>Nginx + lua 防火墙功能</h3><h3 id="复杂访问攻击中CC攻击方式"><a href="#复杂访问攻击中CC攻击方式" class="headerlink" title="复杂访问攻击中CC攻击方式"></a>复杂访问攻击中CC攻击方式</h3><h2 id="1-调试"><a href="#1-调试" class="headerlink" title="1. 调试"></a>1. 调试</h2><h3 id="1-1-查看nginx的状态信息"><a href="#1-1-查看nginx的状态信息" class="headerlink" title="1.1 查看nginx的状态信息"></a>1.1 查看nginx的状态信息</h3><blockquote>
<p>需要编译时安装<code>http_stub_status_module</code>  及config –with-http_stub_status_module</p>
</blockquote>
<pre class="line-numbers language-shell"><code class="language-shell">location /status {
    stub_status on;
    allow 192.168.101.120;
    deny all;
    access_log off;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>访问<a href="http://192.168.1.222/status" target="_blank" rel="noopener">http://192.168.1.222/status</a></p>
<p><img src="http://cdn.linz.tech/nginx-2019-6-13-io-status.png" alt></p>
<p>状态说明</p>
<ul>
<li>Active connections：当前活动的客户端连接数</li>
<li>accepts：已经接收过的客户端连接总数</li>
<li>handled：已经处理过的客户端连接总数</li>
<li>requests：客户端的请求总数</li>
<li>request_time：请求时间</li>
<li>Reading：正在读取的客户端请求数</li>
<li>Writing：正在处理请求或发送响应报文的连接数</li>
<li>Waiting：等待发出请求的空闲连接数</li>
</ul>
<blockquote>
<p>注意：可以配合 基于用户名/密码实现访问控制进行密码校验</p>
</blockquote>
<h3 id="1-2-装载echo模块-用于打印日志"><a href="#1-2-装载echo模块-用于打印日志" class="headerlink" title="1.2 装载echo模块, 用于打印日志"></a>1.2 装载echo模块, 用于打印日志</h3><ol>
<li>下载echo-nginx-module：</li>
</ol>
<pre class="line-numbers language-shell"><code class="language-shell">yum -y install git \
cd /tmp \
git clone https://github.com/openresty/echo-nginx-module.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li><p>使用Tengine的dso_tool工具编译第三方模块：</p>
<pre class="line-numbers language-shell"><code class="language-shell">dso_tool --add-module=/tmp/echo-nginx-module
ls /usr/local/tengine/modules | grep echo  -->  ngx_http_echo_module.so<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>nginx 配置</p>
<pre class="line-numbers language-shell"><code class="language-shell">events{
    dso {
        load ngx_http_echo_module.so;
    }
}
server{
location /echo {
    default_type "text/plain";    # 不指定default_type，会提示下载文件，而非直接输出在浏览器中
    echo "host  -->  $host";                        # 请求主机头字段，否则为服务器名称
    echo "server_name  -->  $server_name";          # 服务器名称
    echo "server_addr  -->  $server_addr";            # 服务器IP地址
    echo "remote_addr  -->  $remote_addr";          # 客户端IP地址
    echo "uri  -->  $uri";                          # 不带请求参数的当前URI，$uri不包含主机名
    echo "document_uri  -->  $document_uri";        # 与$uri含义相同
    echo "request_uri  -->  $request_uri";            # 带请求参数的原始URI，不包含主机名
    echo "request_filename  -->  $request_filename";   # 当前请求的文件路径
    echo "document_root  -->  $document_root";      # 当前请求在root指令中指定的值
}
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>测试</p>
<ul>
<li>nginx -m  –&gt;  ngx_http_echo_module (shared, 3.1)</li>
<li>访问的  <a href="http://www.qiuyue.com/echo" target="_blank" rel="noopener">http://www.qiuyue.com/echo</a></li>
</ul>
</li>
</ol>
<h3 id="Curl-使用"><a href="#Curl-使用" class="headerlink" title="Curl 使用"></a>Curl 使用</h3><p>查看一个完整的http请求</p>
<pre class="line-numbers language-shell"><code class="language-shell">curl -v https://coding.imooc.com > /dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="测试正则表达式"><a href="#测试正则表达式" class="headerlink" title="测试正则表达式"></a>测试正则表达式</h3><p>官网： <a href="https://www.pcre.org/" target="_blank" rel="noopener">https://www.pcre.org/</a></p>
<p>安装</p>
<pre class="line-numbers language-shell"><code class="language-shell">wget https://ftp.pcre.org/pub/pcre/pcre-8.13.tar.gz
tar -xzvf  pcre-8.13.tar.gz
cd pcre-8.13
./configure --enable-utf8  
make && make intall<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用</p>
<pre class="line-numbers language-shell"><code class="language-shell">pcre
pcretest # 正则测试<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>Expresso 巨好用的正则工具</p>
<p>下载地址： <a href="http://www.ultrapico.com/ExpressoDownload.htm" target="_blank" rel="noopener">http://www.ultrapico.com/ExpressoDownload.htm</a></p>
<h3 id="使用返回值调试"><a href="#使用返回值调试" class="headerlink" title="使用返回值调试"></a>使用返回值调试</h3><pre class="line-numbers language-shell"><code class="language-shell">location /test/ {
    default_type application/json;
    return 200 '{"status":"success"}';
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="查看日志"><a href="#查看日志" class="headerlink" title="查看日志"></a>查看日志</h3><pre class="line-numbers language-shell"><code class="language-shell">tail -f /usr/local/tengine/logs/access.log <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="第六章-新特性"><a href="#第六章-新特性" class="headerlink" title="第六章 新特性"></a>第六章 新特性</h1><h2 id="Nginx-平滑升级实现和原理"><a href="#Nginx-平滑升级实现和原理" class="headerlink" title="Nginx 平滑升级实现和原理"></a>Nginx 平滑升级实现和原理</h2><h2 id="HTTP2-0协议特性gRPC"><a href="#HTTP2-0协议特性gRPC" class="headerlink" title="HTTP2.0协议特性gRPC"></a>HTTP2.0协议特性gRPC</h2><h1 id="附录一"><a href="#附录一" class="headerlink" title="附录一"></a>附录一</h1><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a href="https://blog.51cto.com/qiuyue/2114716" target="_blank" rel="noopener">CentOS 7.4 Tengine安装配置详解（一）</a></li>
<li><a href="https://www.jianshu.com/p/00cd4dfe5829" target="_blank" rel="noopener">nginx正则相关变量$1,$2,$3使用注意</a></li>
<li><a href="http://deerchao.net/tutorials/regex/regex.htm" target="_blank" rel="noopener">正则表达式30分钟入门教程</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_6d579ff40100wi7p.html" target="_blank" rel="noopener">Nginx 变量漫谈（一）</a></li>
<li><a href="https://coding.imooc.com/class/chapter/121.html#Anchor" target="_blank" rel="noopener">Nginx入门到实践－Nginx中间件</a></li>
</ol>
<h3 id="神级进阶博文"><a href="#神级进阶博文" class="headerlink" title="神级进阶博文"></a>神级进阶博文</h3><p><a href="http://blog.sina.com.cn/s/articlelist_1834459124_1_1.html" target="_blank" rel="noopener">Nginx 变量漫谈</a></p>
<p><a href="http://blog.sina.com.cn/s/articlelist_1834459124_2_1.html" target="_blank" rel="noopener">Nginx 配置指令的执行顺序</a></p>
<h2 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h2><p><a href="https://nginx.org/en/docs/" target="_blank" rel="noopener">https://nginx.org/en/docs/</a></p>
<h3 id="ngx-http-core-module-参数官网文档"><a href="#ngx-http-core-module-参数官网文档" class="headerlink" title="ngx_http_core_module 参数官网文档"></a>ngx_http_core_module 参数官网文档</h3><blockquote>
<p> 包含在http上下文内的所有参数解析</p>
</blockquote>
<ul>
<li><a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#var_status" target="_blank" rel="noopener">ngx_http_core_module</a></li>
</ul>
<h3 id="ngx-http-log-module（日志模块）"><a href="#ngx-http-log-module（日志模块）" class="headerlink" title="ngx_http_log_module（日志模块）"></a>ngx_http_log_module（日志模块）</h3><p><a href="http://nginx.org/en/docs/http/ngx_http_log_module.html" target="_blank" rel="noopener">http://nginx.org/en/docs/http/ngx_http_log_module.html</a> </p>
<h3 id="Embedded-Variables-（nginx-内置变量）"><a href="#Embedded-Variables-（nginx-内置变量）" class="headerlink" title="Embedded Variables （nginx 内置变量）"></a>Embedded Variables （nginx 内置变量）</h3><p><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#Embedded%20Variables" target="_blank" rel="noopener">Embedded Variables</a></p>
<h1 id="附录二"><a href="#附录二" class="headerlink" title="附录二"></a>附录二</h1><h2 id="Tengine"><a href="#Tengine" class="headerlink" title="Tengine"></a><strong>Tengine</strong></h2><p><a href="https://github.com/alibaba/tengine" target="_blank" rel="noopener">Tengine github</a></p>
<p><a href="http://tengine.taobao.org/documentation.html" target="_blank" rel="noopener">documentation</a></p>
<h2 id="Nginx-conf-标准模板-Tengine"><a href="#Nginx-conf-标准模板-Tengine" class="headerlink" title="Nginx.conf 标准模板(Tengine)"></a>Nginx.conf 标准模板(Tengine)</h2><pre class="line-numbers language-shell"><code class="language-shell">
user tengine;                    # 运行worker进程的用户

worker_processes auto;           # worker进程的个数，命令ps aux | grep nginx可查看启动的worker进程数量

worker_cpu_affinity auto;         # 将worker进程绑定在哪些CPU上，减少由于上下文切换导致的CPU消耗

worker_rlimit_nofile 65535;       # worker进程能够打开的最大文件数限制

error_log logs/error.log error;     # 指定Tengine错误日志的存放路径和级别

pid logs/nginx.pid;              # 指定Tengine进程的pid文件路径

google_perftools_profiles /tmp/tcmalloc;   # tcmalloc保存路径，命令lsof -n | grep tcmalloc验证运行状态



events {

accept_mutex on;           # 让多个worker进程轮流地、序列化地响应新请求

multi_accept on;            # 在Tengine接收到一个新连接通知后，调用accept()来接收尽可能多的连接

worker_connections 65535;   # 单个worker进程所能响应的最大并发连接数

# 此处没有指定use epoll;指令，让Tengine自动选择合适的事件处理模型

}



http {

server_tokens off;           # 隐藏Tengine版本号

include mime.types;         # MIME是网络资源的媒体类型，使用include指令导入mime.types文件

default_type application/octet-stream;   # 指定默认类型



# 自定义访问日志格式，名称为main，指定要保存的日志内容

# ====================================================

# $remote_addr与$http_x_forwarded_for含义相同：客户端的IP地址

# $remote_user：记录客户端用户名称

# $time_local：通用日志格式下的本地服务器时间

# $request：记录请求的URL与HTTP协议

# $status：响应状态码，成功是200

# $body_bytes_sent：发送给客户端HTTP响应的主体内容的字节数大小，不包括响应首部的大小

# $http_referer：记录从哪个页面链接访问过来的

# $http_user_agent：记录客户端浏览器相关信息

# ====================================================

log_format main '$remote_addr - $remote_user [$time_local] "$request" '

                  '$status $body_bytes_sent "$http_referer" '

                 '"$http_user_agent" "$http_x_forwarded_for"';



access_log off;       # 关闭访问日志，提高磁盘的I/O性能

sendfile on;          # 开启高效文件传输模式，调用sendfile()进行数据复制，sendfile()复制数据是在内核级别完成的，所以会比一般的read()、write()更高效，sendfile()可以在磁盘和TCP socket之间互相拷贝数据

tcp_nopush on;      # 开启后服务器的响应头部信息产生独立的数据包发送，即一个响应头信息一个包。在一个数据包里发送所有头文件，而不是一个接一个的发送，用于防止网络阻塞，必须先开启sendfile模式

keepalive_timeout 65; # 客户端keep-alive连接超时时长，服务器将在这个超时时长过后关闭连接，单位秒

charset UTF-8;      # 定义头文件默认字符集



gzip on;                      # 采用gzip压缩形式发送数据，将页面压缩后传输更节省带宽

gzip_disable "msie6";           # IE6的浏览器禁用gzip功能

gzip_proxied any;              # 指定对客户端请求的所有资源启用压缩功能

gzip_min_length 1k;            # 指定对数据启用压缩的最少字节数，如果请求小于1K的文件，不要压缩，压缩小数据会降低处理此请求的所有进程速度

gzip_comp_level 6;             # 指定数据的压缩等级，这个等级可以是1~9之间的任意数值，1压缩比最小但处理速度最快，9处理最慢但压缩比最大，CPU消耗也越大

gzip_buffers 16 8k;             # 指定压缩响应的缓冲区的数量和大小

gzip_vary on;                 # 允许把"Vary: Accept-Encoding"插入响应首部

gzip_http_version 1.1;          # 指定识别HTTP协议版本，默认是1.1

gzip_types text/plain text/css text/xml text/javascript application/json application/x-javascript application/xml application/xml+rss;               # 指定需要压缩的资源类型



reset_timedout_connection on;       # 关闭不响应的客户端连接，释放客户端所占的内存空间

client_body_buffer_size 8k;         # 指定用于读取客户端请求主体的缓冲区大小

client_header_buffer_size 1k;       # 指定用于读取客户端请求首部的缓冲区大小

large_client_header_buffers 4 8k;    # 指定用于读取客户端请求中较大首部的缓冲区的最大数量和大小

client_max_body_size 1m;          # 指定用于客户端请求主体的最大大小

client_header_timeout 30s;         # 指定用于读取客户端请求报文首部的超时时长，单位秒

client_body_timeout 30s;           # 指定用于读取客户端请求报文主体的超时时长，单位秒

send_timeout 30s;                 # 指定用于向客户端发送响应报文的超时时长，单位秒

}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Nginx-Lua-环境容器化脚本"><a href="#Nginx-Lua-环境容器化脚本" class="headerlink" title="Nginx + Lua 环境容器化脚本"></a>Nginx + Lua 环境容器化脚本</h2><p>Dockerfile</p>
<pre class="line-numbers language-shell"><code class="language-shell">FROM centos:latest
MAINTAINER  becivells <becivells@gmail.com> 
RUN yum -y update &&  yum  -y upgrade
RUN yum -y install gcc gcc-c+ openssl openssl-devel pcre-devel zlib-devel  make wget 

ENV TENGINE_VERSION tengine-2.2.3
RUN cd /tmp/ && wget  http://tengine.taobao.org/download/${TENGINE_VERSION}.tar.gz &&\
    tar -zxvf ${TENGINE_VERSION}.tar.gz -C /tmp/ && chmod -R 777 /tmp/${TENGINE_VERSION}
#mkdir
RUN mkdir -p /var/tmp/nginx/client/ &&\
    mkdir -p /var/tmp/nginx/proxy/ &&\
    mkdir -p /var/tmp/nginx/fcgi/ &&\
    mkdir -p /var/tmp/nginx/uwsgi/ &&\
    mkdir -p /var/tmp/nginx/scgi/ 
#./configure

#LuaJIT
RUN cd /tmp/ && wget http://luajit.org/download/LuaJIT-2.0.4.tar.gz && \
    tar xzvf LuaJIT-2.0.4.tar.gz && \
    cd LuaJIT-2.0.4 && \
    make install PREFIX=/usr/local/LuaJIT 

ENV LUAJIT_LIB=/usr/local/LuaJIT/lib 
ENV LUAJIT_INC=/usr/local/LuaJIT/include/luajit-2.0

RUN cd /tmp/ && wget https://github.com/simpl/ngx_devel_kit/archive/v0.3.0.tar.gz && \
    tar -xzvf v0.3.0.tar.gz && \
    wget https://github.com/openresty/lua-nginx-module/archive/v0.10.8.tar.gz && \
    tar -xzvf v0.10.8.tar.gz


RUN cd /tmp/${TENGINE_VERSION} && ./configure \
    --prefix=/opt/${TENGINE_VERSION}/ \
    #--sbin-path=/usr/sbin/nginx \
    #--modules-path=/usr/lib64/nginx/modules \
    #--conf-path=/etc/nginx/nginx.conf \
    --error-log-path=/var/log/nginx/error.log \
    --http-log-path=/var/log/nginx/access.log \
    --pid-path=/var/run/nginx/nginx.pid  \
    --lock-path=/var/lock/nginx.lock \
    --http-client-body-temp-path=/var/tmp/nginx/client/ \
    --http-proxy-temp-path=/var/tmp/nginx/proxy/ \
    --http-fastcgi-temp-path=/var/tmp/nginx/fcgi/ \
    --http-uwsgi-temp-path=/var/tmp/nginx/uwsgi \
    --with-file-aio \
    --with-http_addition_module \
    --with-http_auth_request_module \
    --with-http_dav_module \
    --with-http_flv_module \
    --with-http_gunzip_module \
    --with-http_gzip_static_module \
    --with-http_mp4_module \
    --with-http_random_index_module \
    --with-http_realip_module \
    --with-http_secure_link_module \
    --with-http_slice_module \
    --with-http_ssl_module \
    --with-http_stub_status_module \
    --with-http_sub_module \
    --with-mail \
    --with-mail_ssl_module \
    --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions  -fstack-protector-strong \
    --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC' \
    --with-ld-opt='-Wl,-z,relro -Wl,-z,now -pie' \
    --add-module=/tmp/lua-nginx-module-0.10.8 \
    --add-module=/tmp/ngx_devel_kit-0.3.0 \
    --with-pcre  &&\
    cd /tmp/${TENGINE_VERSION} && make -j 4 && make install && \
    rm -rf /tmp/* && yum clean all && \
    ln -s /opt/${TENGINE_VERSION}/ /opt/tengine && \
    echo "/usr/local/LuaJIT/lib" >> /etc/ld.so.conf && \
    ldconfig
EXPOSE 80
CMD ["/opt/tengine/sbin/nginx", "-g", "daemon off;"] 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></becivells@gmail.com></code></pre>
<p>使用方式</p>
<pre class="line-numbers language-shell"><code class="language-shell">#构建容器
docker build -t centos:tengine .
#指定81端口运行
docker run --rm -p 81:80 centos:tengine
#进入centos:tengine terminal 终端
docker exec -it <container_id> /bin/bash <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></container_id></code></pre>
<p>测试</p>
<pre class="line-numbers language-shell"><code class="language-shell">location /hello {
      default_type 'text/plain';
      content_by_lua 'ngx.say("hello, lua")';
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Nginx全局变量解析"><a href="#Nginx全局变量解析" class="headerlink" title="Nginx全局变量解析"></a>Nginx全局变量解析</h2><pre class="line-numbers language-shelll"><code class="language-shelll">$content_length：http请求头中的Content-length字段

$content_type：http请求头中的Content-Type字段

$document_root：当前请求在root指令中指定的值

$host：请求主机头字段，如果请求中没有Host行，则为服务器名称

$http_user_agent：客户端agent信息

$http_cookie：客户端cookie信息

$limit_rate：限制连接速率

$request_method：客户端请求方法，通常为GET或POST

$remote_addr：客户端IP地址

$remote_port：客户端端口

$remote_user：已经经过Auth Basic Module验证的用户名

$request_filename：当前请求的文件路径，由root或alias指令与URL请求生成

$scheme：请求使用的协议，比如http或者是https

$server_protocol：请求使用的协议版本，通常是HTTP/1.0或HTTP/1.1

$server_addr：服务器地址，在完成一次系统调用后可以确定这个值

$server_name：服务器名称

$server_port：请求到达服务器的端口号

$request_uri：包含请求参数的原始URL，不包含主机名，如：/foo/bar.php?arg=baz

$uri：不带请求参数的当前URL，$uri不包含主机名，如：/foo/bar.html

$document_uri：与$uri相同<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="使用过程中的问题列表"><a href="#使用过程中的问题列表" class="headerlink" title="使用过程中的问题列表"></a>使用过程中的问题列表</h2><h3 id="window-conf-文件加载无效"><a href="#window-conf-文件加载无效" class="headerlink" title="window conf 文件加载无效"></a>window conf 文件加载无效</h3><p>原因是 nginx 在后台启动多个实例导致无法更新到当前使用的实例(<code>在任务列表中可以找到多个nginx实例</code>)</p>
<p>解决：关闭所有nginx.exe, 重新启动</p>
<pre class="line-numbers language-shell"><code class="language-shell">taskkill /IM  nginx.exe  /F <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="增加别名缓存"><a href="#增加别名缓存" class="headerlink" title="增加别名缓存"></a>增加别名缓存</h3><p>错误提示：</p>
<pre><code>could not build the server_names_hash, you should increase server_names_hash_bucket_size: 32</code></pre><p>解决方案：</p>
<pre><code>http{
    server_names_hash_bucket_size 64; #必须是32的倍数
}</code></pre><h3 id="413-request-entity-too-large"><a href="#413-request-entity-too-large" class="headerlink" title="413 request entity too large"></a>413 request entity too large</h3><p>Nginx设置上传文件大小限制</p>
<pre><code>location ^~ /api/media/ {
          proxy_pass http://media_server_pool/media/;
          client_max_body_size 2000m;
}</code></pre>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/知识架构/" rel="tag"># 知识架构</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/09/11/2019-4-13-Java-concurrent/" rel="next" title="Java多线程并发学习笔记">
                <i class="fa fa-chevron-left"></i> Java多线程并发学习笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/09/11/2019-9-11-custome-view/" rel="prev" title="自定义控件其实很简单(笔记一)">
                自定义控件其实很简单(笔记一) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  
    <div class="comments" id="comments">
      <div class="ds-thread" data-thread-key="2019/09/11/2019-6-5-nginx/" data-title="nginx 学习笔记" data-url="http://linz.tech/2019/09/11/2019-6-5-nginx/">
      </div>
    </div>
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="http://cdn.linz.tech/a.gif" alt="北疆">
            
              <p class="site-author-name" itemprop="name">北疆</p>
              <p class="site-description motion-element" itemprop="description">自古以来，所谓豪杰之士，必有过人之节。人情有所不能忍着，匹夫见辱.拔剑而起.挺身而斗，此不足为勇也。天下有大勇者,猝然临之而不惊,无故加之而不怒。而其挟持者甚大，其志甚远也。 ——苏东坡《留候论》</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">75</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/Orange168" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-globe"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://weibo.com/bonanzas" target="_blank" title="微博">
                    
                      <i class="fa fa-fw fa-globe"></i>微博</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://www.jianshu.com/users/53927a5b90c8/latest_articles" target="_blank" title="简书">
                    
                      <i class="fa fa-fw fa-globe"></i>简书</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-globe"></i>
                常用网站
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://androidweekly.net/" title="Androidweekly English" target="_blank">Androidweekly English</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://androidweekly.cn/" title="Androidweekly Chinese" target="_blank">Androidweekly Chinese</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#第一章-Nginx-简介"><span class="nav-number">1.</span> <span class="nav-text">第一章 Nginx 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-0-Basic-HTTP-server-features"><span class="nav-number">1.1.</span> <span class="nav-text">1.0 Basic HTTP server features</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-0-Other-HTTP-server-features"><span class="nav-number">1.2.</span> <span class="nav-text">2.0 Other HTTP server features</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-0-TCP-UDP-proxy-server-features"><span class="nav-number">1.3.</span> <span class="nav-text">3.0 TCP/UDP proxy server features</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-0-Nginx-优点"><span class="nav-number">1.4.</span> <span class="nav-text">4.0 Nginx 优点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第二章-基础篇"><span class="nav-number">2.</span> <span class="nav-text">第二章 基础篇</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx快速搭建"><span class="nav-number">2.1.</span> <span class="nav-text">Nginx快速搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Pre-Built-Packages"><span class="nav-number">2.1.1.</span> <span class="nav-text">Pre-Built Packages</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-基本命令使用"><span class="nav-number">2.2.</span> <span class="nav-text">Nginx 基本命令使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx的目录和配置语法"><span class="nav-number">2.3.</span> <span class="nav-text">Nginx的目录和配置语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Building-nginx-from-Sources"><span class="nav-number">2.3.1.</span> <span class="nav-text">Building nginx from Sources</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Core-functionality"><span class="nav-number">2.3.2.</span> <span class="nav-text">Core functionality</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置模块化"><span class="nav-number">2.3.3.</span> <span class="nav-text">配置模块化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#错误处理"><span class="nav-number">2.3.4.</span> <span class="nav-text">错误处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-日志-log-fromat"><span class="nav-number">2.3.5.</span> <span class="nav-text">Nginx 日志 log_fromat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简单的访问控制"><span class="nav-number">2.3.6.</span> <span class="nav-text">简单的访问控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基于来源IP实现访问控制"><span class="nav-number">2.3.6.1.</span> <span class="nav-text">基于来源IP实现访问控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基于用户名-密码实现访问控制"><span class="nav-number">2.3.6.2.</span> <span class="nav-text">基于用户名/密码实现访问控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#禁止访问某一类资源"><span class="nav-number">2.3.6.3.</span> <span class="nav-text">禁止访问某一类资源</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-变量"><span class="nav-number">2.3.7.</span> <span class="nav-text">Nginx 变量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#自定义变量"><span class="nav-number">2.3.7.1.</span> <span class="nav-text">自定义变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#内建变量"><span class="nav-number">2.3.7.2.</span> <span class="nav-text">内建变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#全局变量"><span class="nav-number">2.3.7.3.</span> <span class="nav-text">全局变量</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-模块讲解"><span class="nav-number">2.4.</span> <span class="nav-text">Nginx 模块讲解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#常用的模块用法"><span class="nav-number">2.4.1.</span> <span class="nav-text">常用的模块用法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-请求限制"><span class="nav-number">2.4.2.</span> <span class="nav-text">Nginx 请求限制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#链接频率限制"><span class="nav-number">2.4.2.1.</span> <span class="nav-text">链接频率限制 :</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#请求频率限制-："><span class="nav-number">2.4.2.2.</span> <span class="nav-text">请求频率限制 ：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-访问控制"><span class="nav-number">2.4.3.</span> <span class="nav-text">Nginx 访问控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基于IP"><span class="nav-number">2.4.3.1.</span> <span class="nav-text">基于IP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基于用户信任登录"><span class="nav-number">2.4.3.2.</span> <span class="nav-text">基于用户信任登录</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第三章-场景实践"><span class="nav-number">3.</span> <span class="nav-text">第三章 场景实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx作为静态资源WEB服务"><span class="nav-number">3.1.</span> <span class="nav-text">Nginx作为静态资源WEB服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-静态资源服务场景-CDN"><span class="nav-number">3.1.1.</span> <span class="nav-text">1, 静态资源服务场景-CDN</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-配置语法"><span class="nav-number">3.1.2.</span> <span class="nav-text">2 配置语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-压缩"><span class="nav-number">3.1.3.</span> <span class="nav-text">3. 压缩</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-浏览器缓存原理"><span class="nav-number">3.1.4.</span> <span class="nav-text">4 浏览器缓存原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-跨域访问"><span class="nav-number">3.1.5.</span> <span class="nav-text">5 跨域访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-防盗链接"><span class="nav-number">3.1.6.</span> <span class="nav-text">6 防盗链接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx作为代理服务"><span class="nav-number">3.2.</span> <span class="nav-text">Nginx作为代理服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#转发路径规则"><span class="nav-number">3.2.1.</span> <span class="nav-text">转发路径规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实战"><span class="nav-number">3.2.2.</span> <span class="nav-text">实战</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx作为负载均衡服务"><span class="nav-number">3.3.</span> <span class="nav-text">Nginx作为负载均衡服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#调度算法"><span class="nav-number">3.3.1.</span> <span class="nav-text">调度算法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx作为缓存服务"><span class="nav-number">3.4.</span> <span class="nav-text">Nginx作为缓存服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#清理指定缓存"><span class="nav-number">3.4.1.</span> <span class="nav-text">清理指定缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#让部分页面不缓存"><span class="nav-number">3.4.2.</span> <span class="nav-text">让部分页面不缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#大文件分片请求"><span class="nav-number">3.4.3.</span> <span class="nav-text">大文件分片请求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#分析"><span class="nav-number">3.4.3.1.</span> <span class="nav-text">分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx动静分离"><span class="nav-number">3.5.</span> <span class="nav-text">Nginx动静分离</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-搭建文件服务器"><span class="nav-number">3.6.</span> <span class="nav-text">Nginx 搭建文件服务器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第四章-深度学习篇"><span class="nav-number">4.</span> <span class="nav-text">第四章 深度学习篇</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx简单的语法"><span class="nav-number">4.1.</span> <span class="nav-text">Nginx简单的语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-变量-1"><span class="nav-number">4.1.1.</span> <span class="nav-text">Nginx 变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Perl兼容正则表达式"><span class="nav-number">4.1.2.</span> <span class="nav-text">Perl兼容正则表达式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实战案例"><span class="nav-number">4.1.3.</span> <span class="nav-text">实战案例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Location使用详解"><span class="nav-number">4.2.</span> <span class="nav-text">Location使用详解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rewrite规则"><span class="nav-number">4.3.</span> <span class="nav-text">Rewrite规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#四种flag标志位"><span class="nav-number">4.3.1.</span> <span class="nav-text">四种flag标志位</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实战案例-1"><span class="nav-number">4.3.2.</span> <span class="nav-text">实战案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优雅的Rewrite规则书写"><span class="nav-number">4.3.3.</span> <span class="nav-text">优雅的Rewrite规则书写</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-高级模块"><span class="nav-number">4.4.</span> <span class="nav-text">Nginx 高级模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#secure-link-module模块"><span class="nav-number">4.4.1.</span> <span class="nav-text">secure_link_module模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置"><span class="nav-number">4.4.1.1.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Sample"><span class="nav-number">4.4.1.2.</span> <span class="nav-text">Sample</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#geoip-module-模块"><span class="nav-number">4.4.2.</span> <span class="nav-text">geoip_module 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#使用场景"><span class="nav-number">4.4.2.1.</span> <span class="nav-text">使用场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-fancyindex-实现文件索引目录"><span class="nav-number">4.4.3.</span> <span class="nav-text">ngx-fancyindex 实现文件索引目录</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基于Nginx的HTTPS服务"><span class="nav-number">4.5.</span> <span class="nav-text">基于Nginx的HTTPS服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#自建CA服务器创建私有CA"><span class="nav-number">4.5.1.</span> <span class="nav-text">自建CA服务器创建私有CA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考"><span class="nav-number">4.5.2.</span> <span class="nav-text">参考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-与Lua开发"><span class="nav-number">4.6.</span> <span class="nav-text">Nginx 与Lua开发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx与Lua特性与优势"><span class="nav-number">4.6.1.</span> <span class="nav-text">Nginx与Lua特性与优势</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lua-基础语法"><span class="nav-number">4.6.2.</span> <span class="nav-text">Lua 基础语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-lua-环境"><span class="nav-number">4.6.3.</span> <span class="nav-text">Nginx + lua 环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-调用lua模块指令"><span class="nav-number">4.6.4.</span> <span class="nav-text">Nginx 调用lua模块指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-lua-API"><span class="nav-number">4.6.5.</span> <span class="nav-text">Nginx lua API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实战-灰度发布"><span class="nav-number">4.6.6.</span> <span class="nav-text">实战-灰度发布</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第五章-Nginx架构篇"><span class="nav-number">5.</span> <span class="nav-text">第五章 Nginx架构篇</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#常见问题"><span class="nav-number">5.1.</span> <span class="nav-text">常见问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#性能优化"><span class="nav-number">5.2.</span> <span class="nav-text">性能优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Apache-ab-压测试工具"><span class="nav-number">5.2.1.</span> <span class="nav-text">Apache ab 压测试工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统和Nginx性能优化"><span class="nav-number">5.2.2.</span> <span class="nav-text">系统和Nginx性能优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件句柄设置"><span class="nav-number">5.2.3.</span> <span class="nav-text">文件句柄设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU亲和性设置"><span class="nav-number">5.2.4.</span> <span class="nav-text">CPU亲和性设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx通用配置优化"><span class="nav-number">5.2.5.</span> <span class="nav-text">Nginx通用配置优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx安全"><span class="nav-number">5.3.</span> <span class="nav-text">Nginx安全</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#恶意行为控制手段"><span class="nav-number">5.3.1.</span> <span class="nav-text">恶意行为控制手段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#攻击手段之暴力破解"><span class="nav-number">5.3.2.</span> <span class="nav-text">攻击手段之暴力破解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件上传漏洞"><span class="nav-number">5.3.3.</span> <span class="nav-text">文件上传漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL注入"><span class="nav-number">5.3.4.</span> <span class="nav-text">SQL注入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx-lua-防火墙功能"><span class="nav-number">5.3.5.</span> <span class="nav-text">Nginx + lua 防火墙功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复杂访问攻击中CC攻击方式"><span class="nav-number">5.3.6.</span> <span class="nav-text">复杂访问攻击中CC攻击方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-调试"><span class="nav-number">5.4.</span> <span class="nav-text">1. 调试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-查看nginx的状态信息"><span class="nav-number">5.4.1.</span> <span class="nav-text">1.1 查看nginx的状态信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-装载echo模块-用于打印日志"><span class="nav-number">5.4.2.</span> <span class="nav-text">1.2 装载echo模块, 用于打印日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Curl-使用"><span class="nav-number">5.4.3.</span> <span class="nav-text">Curl 使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试正则表达式"><span class="nav-number">5.4.4.</span> <span class="nav-text">测试正则表达式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用返回值调试"><span class="nav-number">5.4.5.</span> <span class="nav-text">使用返回值调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看日志"><span class="nav-number">5.4.6.</span> <span class="nav-text">查看日志</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第六章-新特性"><span class="nav-number">6.</span> <span class="nav-text">第六章 新特性</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-平滑升级实现和原理"><span class="nav-number">6.1.</span> <span class="nav-text">Nginx 平滑升级实现和原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP2-0协议特性gRPC"><span class="nav-number">6.2.</span> <span class="nav-text">HTTP2.0协议特性gRPC</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#附录一"><span class="nav-number">7.</span> <span class="nav-text">附录一</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">7.1.</span> <span class="nav-text">参考资料</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#神级进阶博文"><span class="nav-number">7.1.1.</span> <span class="nav-text">神级进阶博文</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#官方文档"><span class="nav-number">7.2.</span> <span class="nav-text">官方文档</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-core-module-参数官网文档"><span class="nav-number">7.2.1.</span> <span class="nav-text">ngx_http_core_module 参数官网文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ngx-http-log-module（日志模块）"><span class="nav-number">7.2.2.</span> <span class="nav-text">ngx_http_log_module（日志模块）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Embedded-Variables-（nginx-内置变量）"><span class="nav-number">7.2.3.</span> <span class="nav-text">Embedded Variables （nginx 内置变量）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#附录二"><span class="nav-number">8.</span> <span class="nav-text">附录二</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Tengine"><span class="nav-number">8.1.</span> <span class="nav-text">Tengine</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-conf-标准模板-Tengine"><span class="nav-number">8.2.</span> <span class="nav-text">Nginx.conf 标准模板(Tengine)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-Lua-环境容器化脚本"><span class="nav-number">8.3.</span> <span class="nav-text">Nginx + Lua 环境容器化脚本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx全局变量解析"><span class="nav-number">8.4.</span> <span class="nav-text">Nginx全局变量解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用过程中的问题列表"><span class="nav-number">8.5.</span> <span class="nav-text">使用过程中的问题列表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#window-conf-文件加载无效"><span class="nav-number">8.5.1.</span> <span class="nav-text">window conf 文件加载无效</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#增加别名缓存"><span class="nav-number">8.5.2.</span> <span class="nav-text">增加别名缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#413-request-entity-too-large"><span class="nav-number">8.5.3.</span> <span class="nav-text">413 request entity too large</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">北疆</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>





    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">本站访客数<span id="busuanzi_value_site_uv"></span>人</span>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zhilinchn"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  
















  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === '') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
