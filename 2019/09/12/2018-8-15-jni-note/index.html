<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Android,实践,经验,">










<meta name="description" content="[TOC] JNI开发流程及HelloWorld基础知识：不同平台的动态库（windows：*.dll，linux/unix：*.so，mac os x：*.jnilib） JNI开发主要流程 第一步、并新建一个HelloWorld.java源文件  package com.study.jnilearn;  public class HelloWorld {      public static">
<meta name="keywords" content="Android,实践,经验">
<meta property="og:type" content="article">
<meta property="og:title" content="JNI&#x2F;NDK开发指南学习笔记">
<meta property="og:url" content="http://linz.tech/2019/09/12/2018-8-15-jni-note/index.html">
<meta property="og:site_name" content="北疆的博客">
<meta property="og:description" content="[TOC] JNI开发流程及HelloWorld基础知识：不同平台的动态库（windows：*.dll，linux/unix：*.so，mac os x：*.jnilib） JNI开发主要流程 第一步、并新建一个HelloWorld.java源文件  package com.study.jnilearn;  public class HelloWorld {      public static">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://cdn.linz.tech/jni_type_blog.jpg">
<meta property="og:image" content="http://cdn.linz.tech/jni_array.jpg">
<meta property="og:image" content="http://cdn.linz.tech/jni_argments_method.png">
<meta property="og:image" content="http://cdn.linz.tech/jni_field_descriptor.png">
<meta property="og:updated_time" content="2020-01-15T10:56:27.153Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JNI&#x2F;NDK开发指南学习笔记">
<meta name="twitter:description" content="[TOC] JNI开发流程及HelloWorld基础知识：不同平台的动态库（windows：*.dll，linux/unix：*.so，mac os x：*.jnilib） JNI开发主要流程 第一步、并新建一个HelloWorld.java源文件  package com.study.jnilearn;  public class HelloWorld {      public static">
<meta name="twitter:image" content="http://cdn.linz.tech/jni_type_blog.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'CD2IHLO3Q2',
      apiKey: 'f3890b1e9cf212771f29d3258b186372',
      indexName: 'LocalSearch',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://linz.tech/2019/09/12/2018-8-15-jni-note/">





  <title>JNI/NDK开发指南学习笔记 | 北疆的博客</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?dd275ba96bfa28cb8bd3809466f17419";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>





<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">北疆的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://linz.tech/2019/09/12/2018-8-15-jni-note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="北疆">
      <meta itemprop="description" content>
      <meta itemprop="image" content="http://cdn.linz.tech/a.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="北疆的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">JNI/NDK开发指南学习笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-12T13:28:32+08:00">
                2019-09-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/note/" itemprop="url" rel="index">
                    <span itemprop="name">note</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/09/12/2018-8-15-jni-note/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/09/12/2018-8-15-jni-note/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 浏览
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>次
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>[TOC]</p>
<h2 id="JNI开发流程及HelloWorld"><a href="#JNI开发流程及HelloWorld" class="headerlink" title="JNI开发流程及HelloWorld"></a><a href="https://blog.csdn.net/xyang81/article/details/41759643" target="_blank" rel="noopener">JNI开发流程及HelloWorld</a></h2><p>基础知识：不同平台的动态库<code>（windows：*.dll，linux/unix：*.so，mac os x：*.jnilib）</code></p>
<h3 id="JNI开发主要流程"><a href="#JNI开发主要流程" class="headerlink" title="JNI开发主要流程"></a>JNI开发主要流程</h3><ol>
<li><p>第一步、并新建一个HelloWorld.java源文件</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">package</span> com<span class="token punctuation">.</span>study<span class="token punctuation">.</span>jnilearn<span class="token punctuation">;</span>
 <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloWorld</span> <span class="token punctuation">{</span>
     <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">native</span> String <span class="token function">sayHello</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 1.声明这是一个native函数，由本地代码实现</span>

     <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         String text <span class="token operator">=</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token string">"yangxin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">// 3.调用本地函数</span>
         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token keyword">static</span> <span class="token punctuation">{</span>
         System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"HelloWorld"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 2.加载实现了native函数的动态库，只需要写动态库的名字</span>
     <span class="token punctuation">}</span>

 <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>用javac命令将.java源文件编译成.class字节码文件</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//-d 指定目录</span>
javac src<span class="token operator">/</span>com<span class="token operator">/</span>study<span class="token operator">/</span>jnilearn<span class="token operator">/</span>HelloWorld<span class="token punctuation">.</span>java <span class="token operator">-</span>d <span class="token punctuation">.</span>/bin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>生成.h头文件</p>
<pre class="line-numbers language-java"><code class="language-java">javah <span class="token operator">-</span>jni <span class="token operator">-</span>classpath <span class="token punctuation">.</span>/bin <span class="token operator">-</span>d <span class="token punctuation">.</span>/jni com<span class="token punctuation">.</span>study<span class="token punctuation">.</span>jnilearn<span class="token punctuation">.</span>HelloWorld<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>实现.h头文件中的函数</p>
</li>
</ol>
<p><em>com_study_jnilearn_HelloWorld.h：</em></p>
<pre><code>```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include &lt;jni.h&gt;</code></pre><p> /* Header for class com_study_jnilearn_HelloWorld */</p>
<pre><code>#ifndef _Included_com_study_jnilearn_HelloWorld
#define _Included_com_study_jnilearn_HelloWorld
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     com_study_jnilearn_HelloWorld
 * Method:    sayHello
 * Signature: (Ljava/lang/String;)Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_com_study_jnilearn_HelloWorld_sayHello</code></pre><p>   (JNIEnv *, jclass, jstring);</p>
<pre><code>#ifdef __cplusplus
}
#endif
#endif
```</code></pre><ol start="5">
<li>将C/C++代码编译成本地动态库文件<pre class="line-numbers language-shell"><code class="language-shell">#-I 包含头文件
# -fPIC：    编译成与位置无关的独立代码
# -shared：编译成动态库
# -o 指定输出
gcc -I$JAVA_HOME/include -I$JAVA_HOME/include/linux -fPIC -shared HelloWorld.c -o libHelloWorld.so<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>运行Java程序</li>
</ol>
<h3 id="so库加载及相关配置"><a href="#so库加载及相关配置" class="headerlink" title="so库加载及相关配置"></a>so库加载及相关配置</h3><p>如果手上有动态库；</p>
<pre class="line-numbers language-txt"><code class="language-txt">win: libHelloWorld.dll，linux/unix：libHelloWorld.so，mac os x：libHelloWorld.jnilib<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>加载方式</strong></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//1. 不需要加lib前缀，也不要加.so、.dll和.jnilib后缀</span>
System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"HelloWorld"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2. 指定动态库的绝对路径名，需要加上前缀和后缀</span>
System<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"/Users/yangxin/Desktop/libHelloWorld.jnilib"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>加载方式1的配置</strong></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//1. 将动态链接库拷贝到java.library.path目录</span>
String libraryDirs <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"java.library.path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>libraryDirs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 输出结果如下：</span>
<span class="token operator">/</span>Users<span class="token operator">/</span>yangxin<span class="token operator">/</span>Library<span class="token operator">/</span>Java<span class="token operator">/</span>Extensions<span class="token operator">:</span><span class="token operator">/</span>Library<span class="token operator">/</span>Java<span class="token operator">/</span>Extensions<span class="token operator">:</span>

<span class="token comment" spellcheck="true">// 2. 指定系统属性java.library.path的值</span>
java <span class="token operator">-</span>Djava<span class="token punctuation">.</span>library<span class="token punctuation">.</span>path<span class="token operator">=</span><span class="token operator">/</span>Users<span class="token operator">/</span>yangxin<span class="token operator">/</span>Desktop
<span class="token comment" spellcheck="true">// 3. 指定库的搜索目录: Linux/Unix环境下可以通过设置LD_LIBRARY_PATH环境变量。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="JNI数据类型"><a href="#JNI数据类型" class="headerlink" title="JNI数据类型"></a><a href="https://blog.csdn.net/xyang81/article/details/42047899" target="_blank" rel="noopener">JNI数据类型</a></h2><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// HelloWorld.java</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">short</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">long</span> l<span class="token punctuation">,</span> <span class="token keyword">float</span> f<span class="token punctuation">,</span> <span class="token keyword">double</span> d<span class="token punctuation">,</span> <span class="token keyword">char</span> c<span class="token punctuation">,</span> 
            <span class="token keyword">boolean</span> z<span class="token punctuation">,</span> <span class="token keyword">byte</span> b<span class="token punctuation">,</span> String str<span class="token punctuation">,</span> Object obj<span class="token punctuation">,</span> MyClass p<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// HelloWorld.h</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_com_study_jnilearn_HelloWorld_test</span>
    <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass cls<span class="token punctuation">,</span> jshort s<span class="token punctuation">,</span> jint i<span class="token punctuation">,</span> jlong l<span class="token punctuation">,</span> jfloat f<span class="token punctuation">,</span>
     jdouble d<span class="token punctuation">,</span> jchar c<span class="token punctuation">,</span> jboolean z<span class="token punctuation">,</span> jbyte b<span class="token punctuation">,</span> jstring j_str<span class="token punctuation">,</span> jobject jobj1<span class="token punctuation">,</span> jobject job2<span class="token punctuation">,</span> jintArray j_int_arr<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>主要类型：</strong><br><img src="http://cdn.linz.tech/jni_type_blog.jpg" alt></p>
<p><strong>数组：</strong><br><img src="http://cdn.linz.tech/jni_array.jpg" alt></p>
<p><strong>其他</strong><br>JNIEnv和jclass</p>
<h3 id="jobject-C-and-C-不同"><a href="#jobject-C-and-C-不同" class="headerlink" title="jobject C++ and C 不同"></a>jobject C++ and C 不同</h3><p>C++ 和Java一样面向对象</p>
<blockquote>
<p>所有引用类型自jobject派生</p>
</blockquote>
<pre><code>class _jobject {};
   class _jclass : public _jobject {};
   class _jstring : public _jobject {};
   class _jarray : public _jobject {};
   class _jbooleanArray : public _jarray {};
   class _jbyteArray : public _jarray {};
   ...</code></pre><p>C 使用typedef重新定义，如：typedef jobject jstring</p>
<p>*<em>jvalue *</em></p>
<pre class="line-numbers language-java"><code class="language-java">typedef union jvalue <span class="token punctuation">{</span>
    jboolean z<span class="token punctuation">;</span>
    jbyte    b<span class="token punctuation">;</span>
    jchar    c<span class="token punctuation">;</span>
    jshort   s<span class="token punctuation">;</span>
    jint     i<span class="token punctuation">;</span>
    jlong    j<span class="token punctuation">;</span>
    jfloat   f<span class="token punctuation">;</span>
    jdouble  d<span class="token punctuation">;</span>
    jobject  l<span class="token punctuation">;</span>
<span class="token punctuation">}</span> jvalue<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="字符串处理"><a href="#字符串处理" class="headerlink" title="字符串处理"></a><a href="https://blog.csdn.net/xyang81/article/details/42066665" target="_blank" rel="noopener">字符串处理</a></h2><p>基础知识</p>
<ul>
<li>JNI把Java中的所有对象当作一个C指针传递到本地方法中，这个指针指向JVM中的内部数据结构，而内部的数据结构在内存中的存储方式是不可见的。只能从JNIEnv指针指向的函数表中选择合适的JNI函数来操作JVM中的数据结构</li>
<li>Java默认使用Unicode编码，而C/CPP默认使用UTF编码；GetXXUTFXX/ReleaseXXUTFXX 用于C/CPP </li>
</ul>
<h3 id="字符三部曲-GET-gt-Release-gt-New"><a href="#字符三部曲-GET-gt-Release-gt-New" class="headerlink" title="字符三部曲 GET -> Release -> New"></a>字符三部曲 GET -&gt; Release -&gt; New</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>c_str <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    jboolean isCopy<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 返回JNI_TRUE表示原字符串的拷贝，返回JNI_FALSE表示返回原字符串的指针</span>
    c_str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_str<span class="token punctuation">,</span> <span class="token operator">&amp;</span>isCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"C_str: %s \n"</span><span class="token punctuation">,</span> c_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sprintf</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span> <span class="token string">"hello %s"</span><span class="token punctuation">,</span> c_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_str<span class="token punctuation">,</span> c_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>GetStringUTFChars(env, j_str, &amp;isCopy) 说明：</p>
<ul>
<li>isCopy 默认为NULL就好<ul>
<li>JNI_TRUE Jvm中j_str复制一份;</li>
<li>JNI_FALSE 返回源字符串的内容，不推荐；</li>
</ul>
</li>
<li>UTF <font color="#EA0000" face="STHupo">Java默认使用Unicode编码，而C/C++默认使用UTF编码</font>，GetStringUTFChars可以把一个jstring指针（指向JVM内部的Unicode字符序列）转换成一个UTF-8格式的C字符串</li>
</ul>
<h3 id="异常检查"><a href="#异常检查" class="headerlink" title="异常检查"></a>异常检查</h3><blockquote>
<p>因为JVM需要为新诞生的字符串分配内存空间，当内存空间不够分配的时候，会导致调用失败，失败后GetStringUTFChars会返回NULL，并抛出一个OutOfMemoryError异常。JNI的异常不会停止而是继续往下，留下一个空指针。</p>
</blockquote>
<p>if(GetStringUTFChars == NULL ) return ;</p>
<h3 id="释放字符串"><a href="#释放字符串" class="headerlink" title="释放字符串"></a>释放字符串</h3><blockquote>
<p><font color="red" face="STHupo">GetStringUTFChars</font> 会分配内存需释放</p>
</blockquote>
<p>同理： <font color="red" face="STHupo">GETXX</font>就必须调用<font color="red" face="STHupo">ReleaseXXX</font></p>
<h3 id="NewStringUTF"><a href="#NewStringUTF" class="headerlink" title="NewStringUTF"></a>NewStringUTF</h3><pre><code>graph LR
NewStringUTF --&gt; JVM新建java.lang.String; 
JVM新建java.lang.String --&gt; 没有内存;
没有内存--&gt; OutOfMemoryError ;</code></pre><h3 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h3><ul>
<li>Get和ReleaseStringChars(Unicode)vs Get/ReleaseStringUTFChars(UTF-8)</li>
<li>GetStringLength/GetStringUTFLength 由于UTF-8编码的字符串以’\0’结尾，而Unicode字符串不是。</li>
<li>Get/ReleaseStringCritical：提高JVM返回源字符串直接指针的可能性<ul>
<li>当字符1M左右，较大时使用</li>
<li>两个代码间，不可以执行导致阻塞的调用或为新对象在JVM中分配内存，否则，JVM有可能死锁。<pre class="line-numbers language-java"><code class="language-java">JNIEXPORT jstring JNICALL <span class="token function">Java_com_study_jnilearn_Sample_sayHello</span>
<span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass cls<span class="token punctuation">,</span> jstring j_str<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token keyword">const</span> jchar<span class="token operator">*</span> c_str<span class="token operator">=</span> NULL<span class="token punctuation">;</span>
<span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hello "</span><span class="token punctuation">;</span>
<span class="token keyword">char</span><span class="token operator">*</span> pBuff <span class="token operator">=</span> buff <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/*
* 在GetStringCritical/RealeaseStringCritical之间是一个关键区。
* 在这关键区之中,绝对不能呼叫JNI的其他函数和会造成当前线程中断或是会让当前线程等待的任何本地代码，
* 否则将造成关键区代码执行区间垃圾回收器停止运作，任何触发垃圾回收器的线程也会暂停。
* 其他触发垃圾回收器的线程不能前进直到当前线程结束而激活垃圾回收器。
*/</span>
c_str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStringCritical</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>j_str<span class="token punctuation">,</span>NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 返回源字符串指针的可能性</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>c_str <span class="token operator">==</span> NULL<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 验证是否因为字符串拷贝内存溢出而返回NULL</span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>c_str<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
  <span class="token operator">*</span>pBuff<span class="token operator">++</span> <span class="token operator">=</span> <span class="token operator">*</span>c_str<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">ReleaseStringCritical</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>j_str<span class="token punctuation">,</span>c_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li>GetStringRegion和GetStringUTFRegion 源字符串复制到一个预先分配的缓冲区内【不分配内存】，UTF越界 会报StringIndexOutOfBoundsException; 【推荐使用】<ul>
<li>缓冲区可以被编译器提前分配，而且永远不会产生内存溢出的异常</li>
<li>提供了一个开始索引和子字符串的长度值</li>
<li>复制少量字符串的消耗非常小<pre class="line-numbers language-java"><code class="language-java">jsize len <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStringLength</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>j_str<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 获取unicode字符串的长度</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"str_len:%d\n"</span><span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hello "</span><span class="token punctuation">;</span>
<span class="token keyword">char</span><span class="token operator">*</span> pBuff <span class="token operator">=</span> buff <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 将JVM中的字符串以utf-8编码拷入C缓冲区,该函数内部不会分配内存空间</span>
<span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStringUTFRegion</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>j_str<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>len<span class="token punctuation">,</span>pBuff<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
</ul>
<h2 id="Crash错误定位"><a href="#Crash错误定位" class="headerlink" title="Crash错误定位"></a><a href="https://blog.csdn.net/xyang81/article/details/42319789" target="_blank" rel="noopener">Crash错误定位</a></h2><p><code>sdk\ndk-bundle\toolchains</code>选择出分析对应CPU架构的so文件</p>
<table>
<thead>
<tr>
<th>Toolchain</th>
<th>Location</th>
</tr>
</thead>
<tbody><tr>
<td>arm</td>
<td>$TOOLCHAIN/arm-linux-androideabi/lib/</td>
</tr>
<tr>
<td>arm64</td>
<td>$TOOLCHAIN/aarch64-linux-android/lib/</td>
</tr>
<tr>
<td>x86</td>
<td>$TOOLCHAIN/i686-linux-android/lib/</td>
</tr>
<tr>
<td>x86_64</td>
<td>$TOOLCHAIN/x86_64-linux-android/lib/</td>
</tr>
</tbody></table>
<pre><code> #02 pc 0000242f  /data/app/com.hard.dev.spiproject-C3PjhijiVGgyqX2M1fK3KQ==/lib/arm/libspi-lib.so (will_crash+30)
 #03 pc 0000245b  /data/app/com.hard.dev.spiproject-C3PjhijiVGgyqX2M1fK3KQ==/lib/arm/libspi-lib.so (JNI_OnLoad+18)</code></pre><p>两位数字 pc”开头的都是backtrace日志<br> 0000242f 0000245b为</p>
<ol>
<li>arm-linux-androideabi-addr2line 定位出错位置</li>
</ol>
<pre><code>adb pull /data/app/com.hard.dev.spiproject-C3PjhijiVGgyqX2M1fK3KQ==/lib/arm/libspi-lib.so
arm-linux-androideabi-addr2line -e libspi-lib.so 0000242f 0000245b</code></pre><ol start="2">
<li>使用arm-linux-androideabi-objdump  定位出错的函数信息<pre><code>arm-linux-androideabi-objdump -S -D libspi-lib.so &gt; dump.log</code></pre></li>
<li>ndk-stack<pre><code>adb logcat &gt; /tmp/foo.txt
#其中$PROJECT_PATH/obj/local/armeabi-v7a 指定生成的so库路径
$NDK/ndk-stack -sym $PROJECT_PATH/obj/local/armeabi-v7a -dump foo.txt</code></pre>输出 <font color="red" face="STCaiyun">Routine</font>后有指明保存源码位置<pre><code>Stack frame #05  pc 00000d1c  /data/app-lib/com.example.hellojni-1/libhello-jni.so (JNI_OnLoad+20):Routine JNI_OnLoad at /samples/hello-jni/jni/hello-jni.c:15</code></pre></li>
</ol>
<h2 id="访问数组（基本类型数组与对象数组）"><a href="#访问数组（基本类型数组与对象数组）" class="headerlink" title="访问数组（基本类型数组与对象数组）"></a><a href="https://blog.csdn.net/xyang81/article/details/42346165" target="_blank" rel="noopener">访问数组（基本类型数组与对象数组）</a></h2><h3 id="GetIntArrayRegion-【小量的、固定大小的数组】"><a href="#GetIntArrayRegion-【小量的、固定大小的数组】" class="headerlink" title="GetIntArrayRegion 【小量的、固定大小的数组】"></a>GetIntArrayRegion 【小量的、固定大小的数组】</h3><p>返回Int型数组的和例子</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* DO NOT EDIT THIS FILE - it is machine generated */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;jni.h></span></span>
<span class="token comment" spellcheck="true">/* Header for class com_study_jnilearn_IntArray */</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> _Included_com_study_jnilearn_IntArray</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _Included_com_study_jnilearn_IntArray</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> __cplusplus</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token comment" spellcheck="true">/*
 * Class:     com_study_jnilearn_IntArray
 * Method:    sumArray
 * Signature: ([I)I
 */</span>
JNIEXPORT jint JNICALL <span class="token function">Java_com_study_jnilearn_IntArray_sumArray</span>
  <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span><span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jintArray<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> __cplusplus</span>
<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token comment" spellcheck="true">// IntArray.c</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"com_study_jnilearn_IntArray.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>

<span class="token comment" spellcheck="true">/*
 * Class:     com_study_jnilearn_IntArray
 * Method:    sumArray
 * Signature: ([I)I
 */</span>
JNIEXPORT jint JNICALL <span class="token function">Java_com_study_jnilearn_IntArray_sumArray</span>
<span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">,</span> jintArray j_array<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    jint i<span class="token punctuation">,</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    jint <span class="token operator">*</span>c_array<span class="token punctuation">;</span>
    jint arr_len<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//1. 获取数组长度</span>
    arr_len <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetArrayLength</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>j_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//2. 根据数组长度和数组元素的数据类型申请存放java数组元素的缓冲区</span>
    c_array <span class="token operator">=</span> <span class="token punctuation">(</span>jint<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>jint<span class="token punctuation">)</span> <span class="token operator">*</span> arr_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//3. 初始化缓冲区</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>c_array<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>jint<span class="token punctuation">)</span><span class="token operator">*</span>arr_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"arr_len = %d "</span><span class="token punctuation">,</span> arr_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//4. 拷贝Java数组中的所有元素到缓冲区中</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetIntArrayRegion</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>j_array<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>arr_len<span class="token punctuation">,</span>c_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr_len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sum <span class="token operator">+</span><span class="token operator">=</span> c_array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//5. 累加数组元素的和</span>
    <span class="token punctuation">}</span>
    <span class="token function">free</span><span class="token punctuation">(</span>c_array<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//6. 释放存储数组元素的缓冲区</span>
    <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="优化GetIntArrayElements"><a href="#优化GetIntArrayElements" class="headerlink" title="优化GetIntArrayElements"></a>优化GetIntArrayElements</h3><pre class="line-numbers language-c"><code class="language-c">JNIEXPORT jint JNICALL <span class="token function">Java_com_study_jnilearn_IntArray_sumArray2</span>
<span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">,</span> jintArray j_array<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    jint i<span class="token punctuation">,</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    jint <span class="token operator">*</span>c_array<span class="token punctuation">;</span>
    jint arr_len<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 可能数组中的元素在内存中是不连续的，JVM可能会复制所有原始数据到缓冲区，然后返回这个缓冲区的指针</span>
    c_array <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetIntArrayElements</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>j_array<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// NULL JNI_TRUE 缓冲区数组指针 JNI_FALSE 原始</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c_array <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// JVM复制原始数据到缓冲区失败</span>
    <span class="token punctuation">}</span>
    arr_len <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetArrayLength</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>j_array<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"arr_len = %d\n"</span><span class="token punctuation">,</span> arr_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr_len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sum <span class="token operator">+</span><span class="token operator">=</span> c_array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ReleaseIntArrayElements</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>j_array<span class="token punctuation">,</span> c_array<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 释放可能复制的缓冲区</span>
    <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="GetIntArrayElements-缺点"><a href="#GetIntArrayElements-缺点" class="headerlink" title="GetIntArrayElements 缺点"></a>GetIntArrayElements 缺点</h3><ul>
<li>有可能在申请开辟临时缓冲区内存空间时，会内存不足导致申请失败，返回NULL</li>
<li>GC占用对象锁，导致本地线程一直堵塞</li>
</ul>
<h3 id="Get-ReleasePrimitiveArrayCritical-暂停GC"><a href="#Get-ReleasePrimitiveArrayCritical-暂停GC" class="headerlink" title="Get/ReleasePrimitiveArrayCritical 暂停GC"></a>Get/ReleasePrimitiveArrayCritical 暂停GC</h3><ul>
<li>特点：地代码在访问数组对象时会暂停GC线程</li>
<li>注意：两个函数期间不能调用任何会让线程阻塞或等待JVM中其它线程的本地函数或JNI函数</li>
</ul>
<h2 id="对象数组"><a href="#对象数组" class="headerlink" title="对象数组"></a>对象数组</h2><h3 id="Get-SetObjectArrayElement"><a href="#Get-SetObjectArrayElement" class="headerlink" title="Get/SetObjectArrayElement"></a>Get/SetObjectArrayElement</h3><p>案例：ObjectArray.java</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>study<span class="token punctuation">.</span>jnilearn<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjectArray</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">initInt2DArray</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ObjectArray obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">initInt2DArray</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"arr[%d][%d] = %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"ObjectArray"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>C语言</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* DO NOT EDIT THIS FILE - it is machine generated */</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;jni.h></span></span>
<span class="token comment" spellcheck="true">/* Header for class com_study_jnilearn_ObjectArray */</span>

<span class="token macro property">#<span class="token directive keyword">ifndef</span> _Included_com_study_jnilearn_ObjectArray</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _Included_com_study_jnilearn_ObjectArray</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> __cplusplus</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token comment" spellcheck="true">/*
 * Class:     com_study_jnilearn_ObjectArray
 * Method:    initInt2DArray
 * Signature: (I)[[I
 */</span>
JNIEXPORT jobjectArray JNICALL <span class="token function">Java_com_study_jnilearn_ObjectArray_initInt2DArray</span>
  <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span><span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jint<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> __cplusplus</span>
<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>


<span class="token comment" spellcheck="true">// ObjectArray.c</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"com_study_jnilearn_ObjectArray.h"</span></span>
<span class="token comment" spellcheck="true">/*
 * Class:     com_study_jnilearn_ObjectArray
 * Method:    initInt2DArray
 * Signature: (I)[[I
 */</span>
JNIEXPORT jobjectArray JNICALL <span class="token function">Java_com_study_jnilearn_ObjectArray_initInt2DArray</span>
  <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">,</span> jint size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    jobjectArray result<span class="token punctuation">;</span>
    jclass clsIntArray<span class="token punctuation">;</span>
    jint i<span class="token punctuation">,</span>j<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 1.获得一个int型二维数组类的引用</span>
    clsIntArray <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span><span class="token string">"[I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//"[I" JNI class descript</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clsIntArray <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 2.创建一个数组对象（里面每个元素用clsIntArray表示）</span>
    <span class="token comment" spellcheck="true">// 说明： 函数NewObjectArray只能分配第一维，JVM没有与多维数组相对应的数据结构，JNI也没有提供类似的函数来创建二维数组</span>
    result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewObjectArray</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>size<span class="token punctuation">,</span>clsIntArray<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 3.为数组元素赋值</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        jint buff<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        jintArray intArr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewIntArray</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>intArr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            buff<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">+</span> j<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//把buff[]缓冲中的内容复制到新分配的一维数组中</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">SetIntArrayRegion</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>intArr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>size<span class="token punctuation">,</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">SetObjectArrayElement</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>result<span class="token punctuation">,</span> i<span class="token punctuation">,</span> intArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">//避免在循环内创建大量的JNI局部引用，造成JNI引用表溢出</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>intArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="JVM引用"><a href="#JVM引用" class="headerlink" title="JVM引用"></a>JVM引用</h3><p> 在JNI中，只有jobject以及子类属于引用变量，会占用引用表的空间，jint，jfloat，jboolean等都是基本类型变量，不会占用引用表空间，即不需要释放。引用表最大空间为512个，如果超出这个范围，JVM就会挂掉。</p>
<h2 id="C-C-访问Java实例方法和静态方法"><a href="#C-C-访问Java实例方法和静态方法" class="headerlink" title="C/C++访问Java实例方法和静态方法"></a><a href="https://blog.csdn.net/xyang81/article/details/42582213" target="_blank" rel="noopener">C/C++访问Java实例方法和静态方法</a></h2><h3 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h3><p><strong>AccessMethod.java</strong></p>
<pre class="line-numbers language-c"><code class="language-c">package com<span class="token punctuation">.</span>study<span class="token punctuation">.</span>jnilearn<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * AccessMethod.java
 * 本地代码访问类的实例方法和静态方法
 * @author yangxin
 */</span>
public class AccessMethod <span class="token punctuation">{</span>

    public <span class="token keyword">static</span> native <span class="token keyword">void</span> <span class="token function">callJavaStaticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    public <span class="token keyword">static</span> native <span class="token keyword">void</span> <span class="token function">callJavaInstaceMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    public <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callJavaStaticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callJavaInstaceMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"AccessMethod"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>ClassMethod.java</strong></p>
<pre class="line-numbers language-c"><code class="language-c">package com<span class="token punctuation">.</span>study<span class="token punctuation">.</span>jnilearn<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * ClassMethod.java
 * 用于本地代码调用
 * @author yangxin
 */</span>
public class ClassMethod <span class="token punctuation">{</span>

    private <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">callStaticMethod</span><span class="token punctuation">(</span>String str<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"ClassMethod::callStaticMethod called!-->str=%s,"</span> <span class="token operator">+</span>
                <span class="token string">" i=%d\n"</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    private <span class="token keyword">void</span> <span class="token function">callInstanceMethod</span><span class="token punctuation">(</span>String str<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"ClassMethod::callInstanceMethod called!-->str=%s, "</span> <span class="token operator">+</span>
                <span class="token string">"i=%d\n"</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Jni 源码</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// AccessMethod.c</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"com_study_jnilearn_AccessMethod.h"</span></span>

<span class="token comment" spellcheck="true">/*
 * Class:     com_study_jnilearn_AccessMethod
 * Method:    callJavaStaticMethod
 * Signature: ()V
 */</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_com_study_jnilearn_AccessMethod_callJavaStaticMethod</span>
<span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass cls<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    jclass clazz <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    jstring str_arg <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    jmethodID mid_static_method<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 1、从classpath路径下搜索ClassMethod这个类，并返回该类的Class对象</span>
    clazz <span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span><span class="token string">"com/study/jnilearn/ClassMethod"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 2、从clazz类中查找callStaticMethod方法</span>
    mid_static_method <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>clazz<span class="token punctuation">,</span><span class="token string">"callStaticMethod"</span><span class="token punctuation">,</span><span class="token string">"(Ljava/lang/String;I)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mid_static_method <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"找不到callStaticMethod这个静态方法。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 3、调用clazz类的callStaticMethod静态方法</span>
    str_arg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span><span class="token string">"我是静态方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">CallStaticVoidMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>clazz<span class="token punctuation">,</span>mid_static_method<span class="token punctuation">,</span> str_arg<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 删除局部引用</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>str_arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*
 * Class:     com_study_jnilearn_AccessMethod
 * Method:    callJavaInstaceMethod
 * Signature: ()V
 */</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_com_study_jnilearn_AccessMethod_callJavaInstaceMethod</span>
<span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass cls<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    jclass clazz <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    jobject jobj <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    jmethodID mid_construct <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    jmethodID mid_instance <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    jstring str_arg <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 1、从classpath路径下搜索ClassMethod这个类，并返回该类的Class对象</span>
    clazz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"com/study/jnilearn/ClassMethod"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"找不到'com.study.jnilearn.ClassMethod'这个类"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 2、获取类的默认构造方法ID</span>
    mid_construct <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>clazz<span class="token punctuation">,</span> <span class="token string">"&lt;init>"</span><span class="token punctuation">,</span><span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mid_construct <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"找不到默认的构造方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 3、查找实例方法的ID</span>
    mid_instance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"callInstanceMethod"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;I)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mid_instance <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 4、创建该类的实例</span>
    jobj <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewObject</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>clazz<span class="token punctuation">,</span>mid_construct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>jobj <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"在com.study.jnilearn.ClassMethod类中找不到callInstanceMethod方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 5、调用对象的实例方法</span>
    str_arg <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span><span class="token string">"我是实例方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">CallVoidMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>jobj<span class="token punctuation">,</span>mid_instance<span class="token punctuation">,</span>str_arg<span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 删除局部引用</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>jobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>str_arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="callJavaStaticMethod静态方法实现说明"><a href="#callJavaStaticMethod静态方法实现说明" class="headerlink" title="callJavaStaticMethod静态方法实现说明"></a>callJavaStaticMethod静态方法实现说明</h3><p>++void (JNICALL *CallStaticVoidMethod)(JNIEnv *env, jclass cls, jmethodID methodID, …);++</p>
<ul>
<li>env：JNI函数表指针</li>
<li>cls：调用该静态方法的Class对象</li>
<li>methodID：方法唯一ID</li>
<li>… 参数4：方法实参列表  </li>
</ul>
<p>其他方法</p>
<ul>
<li>CallStaticXXXMethod<blockquote>
<p>CallStaticIntMethod、CallStaticFloatMethod、CallStaticShortMethod、CallStaticObjectMethod</p>
</blockquote>
</li>
</ul>
<h3 id="callInstanceMethod实例方法实现说明"><a href="#callInstanceMethod实例方法实现说明" class="headerlink" title="callInstanceMethod实例方法实现说明"></a>callInstanceMethod实例方法实现说明</h3><p>++void (JNICALL *CallVoidMethod) (JNIEnv *env, jobject obj, jmethodID methodID, …);++</p>
<ul>
<li>env：JNI函数表指针</li>
<li>obj：调用该方法的实例 【于上不同】</li>
<li>methodID：方法唯一ID</li>
<li>… 参数4：方法实参列表  </li>
</ul>
<h4 id="相关的函数CallXXXMethod"><a href="#相关的函数CallXXXMethod" class="headerlink" title="相关的函数CallXXXMethod"></a>相关的函数CallXXXMethod</h4><blockquote>
<p>（CallXXXMethod），如：CallIntMethod、CallFloatMethod、CallObjectMethod等</p>
</blockquote>
<h3 id="方法签名"><a href="#方法签名" class="headerlink" title="方法签名"></a>方法签名</h3><p>fadfaf</p>
<h4 id="方法签名的格式"><a href="#方法签名的格式" class="headerlink" title="方法签名的格式"></a>方法签名的格式</h4><p><img src="http://cdn.linz.tech/jni_argments_method.png" alt></p>
<h4 id="基本类型映射关系"><a href="#基本类型映射关系" class="headerlink" title="基本类型映射关系"></a>基本类型映射关系</h4><p><img src="http://cdn.linz.tech/jni_field_descriptor.png" alt></p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>获取构造方法ID，方法名称使用”<init>“</init></li>
</ul>
<h2 id="C-C-访问Java实例Field和static-Field"><a href="#C-C-访问Java实例Field和static-Field" class="headerlink" title="C/C++访问Java实例Field和static Field"></a><a href="https://blog.csdn.net/xyang81/article/details/42836783" target="_blank" rel="noopener">C/C++访问Java实例Field和static Field</a></h2><blockquote>
<p>C/C++代码中可以访问任意Java类中的属性</p>
</blockquote>
<h3 id="实战Demo"><a href="#实战Demo" class="headerlink" title="实战Demo"></a>实战Demo</h3><p>AccessField.java</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>study<span class="token punctuation">.</span>jnilearn<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * C/C++访问类的实例变量和静态变量
 * @author yangxin
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccessField</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">accessInstanceField</span><span class="token punctuation">(</span>ClassField obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">accessStaticField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ClassField obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj<span class="token punctuation">.</span><span class="token function">setStr</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 本地代码访问和修改ClassField为中的静态属性num</span>
        <span class="token function">accessStaticField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">accessInstanceField</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 输出本地代码修改过后的值</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"In Java--->ClassField.num = "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"In Java--->ClassField.str = "</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span><span class="token function">getStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"AccessField"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ClassField.java</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>study<span class="token punctuation">.</span>jnilearn<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">/**
 * ClassField.java
 * 用于本地代码访问和修改该类的属性
 * @author yangxin
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassField</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> num<span class="token punctuation">;</span>

    <span class="token keyword">private</span> String str<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> num<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNum</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ClassField<span class="token punctuation">.</span>num <span class="token operator">=</span> num<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> str<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setStr</span><span class="token punctuation">(</span>String str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>str <span class="token operator">=</span> str<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Native 代码</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// AccessField.c</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"com_study_jnilearn_AccessField.h"</span></span>

<span class="token comment" spellcheck="true">/*
 * Class:     com_study_jnilearn_AccessField
 * Method:    accessInstanceField
 * Signature: ()V
 */</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_com_study_jnilearn_AccessField_accessInstanceField</span>
<span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass cls<span class="token punctuation">,</span> jobject obj<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    jclass clazz<span class="token punctuation">;</span>
    jfieldID fid<span class="token punctuation">;</span>
    jstring j_str<span class="token punctuation">;</span>
    jstring j_newStr<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>c_str <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 1.获取AccessField类的Class引用</span>
    clazz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetObjectClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 2. 获取AccessField类实例变量str的属性ID</span>
    fid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetFieldID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>clazz<span class="token punctuation">,</span><span class="token string">"str"</span><span class="token punctuation">,</span> <span class="token string">"Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 3. 获取实例变量str的值</span>
    j_str <span class="token operator">=</span> <span class="token punctuation">(</span>jstring<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetObjectField</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>obj<span class="token punctuation">,</span>fid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 4. 将unicode编码的java字符串转换成C风格字符串</span>
    c_str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>j_str<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c_str <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In C--->ClassField.str = %s\n"</span><span class="token punctuation">,</span> c_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_str<span class="token punctuation">,</span> c_str<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 5. 修改实例变量str的值</span>
    j_newStr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"This is C String"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>j_newStr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">SetObjectField</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> fid<span class="token punctuation">,</span> j_newStr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 6.删除局部引用</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_newStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/*
 * Class:     com_study_jnilearn_AccessField
 * Method:    accessStaticField
 * Signature: ()V
 */</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_com_study_jnilearn_AccessField_accessStaticField</span>
<span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass cls<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    jclass clazz<span class="token punctuation">;</span>
    jfieldID fid<span class="token punctuation">;</span>
    jint num<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//1.获取ClassField类的Class引用</span>
    clazz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span><span class="token string">"com/study/jnilearn/ClassField"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 错误处理</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//2.获取ClassField类静态变量num的属性ID</span>
    fid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetStaticFieldID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"num"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fid <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 3.获取静态变量num的值</span>
    num <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetStaticIntField</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>clazz<span class="token punctuation">,</span>fid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In C--->ClassField.num = %d\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 4.修改静态变量num的值</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">SetStaticIntField</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> fid<span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 删除属部引用</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="访问实例Field"><a href="#访问实例Field" class="headerlink" title="访问实例Field"></a>访问实例Field</h3><h4 id="GetXXField"><a href="#GetXXField" class="headerlink" title="GetXXField"></a>GetXXField</h4><blockquote>
<p>GetIntField，GetFloatField，GetDoubleField，GetBooleanField等</p>
</blockquote>
<pre><code>jobject (JNICALL *GetObjectField) (JNIEnv *env, jobject obj, jfieldID fieldID);</code></pre><ul>
<li>env是JNI函数表指针</li>
<li>obj是实例变量所属的对象</li>
<li>fieldID是变量的ID  </li>
</ul>
<p>类比Java反射</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
    ClassField obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token punctuation">.</span><span class="token function">setStr</span><span class="token punctuation">(</span><span class="token string">"YangXin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 获取ClassField字节码对象的Class引用</span>
    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token comment" spellcheck="true">// 获取str属性</span>
    Field field <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"str"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 取消权限检查，因为Java语法规定，非public属性是无法在外部访问的</span>
    field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 获取obj对象中的str属性的值</span>
    String str <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span>field<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"str = "</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Jni的步骤</p>
<pre><code>clazz = (*env)-&gt;GetObjectClass(env,obj);
fid = (*env)-&gt;GetFieldID(env,clazz,"str", "Ljava/lang/String;");
j_str = (jstring)(*env)-&gt;GetObjectField(env,obj,fid);
//修改实例属性的值为j_newStr
(*env)-&gt;SetObjectField(env, obj, fid, j_newStr);</code></pre><p>++SetObjectField++ 类似的有<code>SetIntField、SetDoubleField、SetBooleanField等</code></p>
<h3 id="访问静态变量"><a href="#访问静态变量" class="headerlink" title="访问静态变量"></a>访问静态变量</h3><pre><code>// 3.获取静态变量num的值
num = (*env)-&gt;GetStaticIntField(env,clazz,fid);
// 4.修改静态变量num的值
(*env)-&gt;SetStaticIntField(env, clazz, fid, 80);</code></pre><h2 id="调用构造方法和父类实例方法"><a href="#调用构造方法和父类实例方法" class="headerlink" title="调用构造方法和父类实例方法"></a><a href="https://blog.csdn.net/xyang81/article/details/44002089" target="_blank" rel="noopener">调用构造方法和父类实例方法</a></h2><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>Java代码</p>
<pre><code>// Animal.java
package com.study.jnilearn;
public class Animal {

    protected String name;

    public Animal(String name) {
        this.name = name;
        System.out.println("Animal Construct call...");
    }

    public String getName() {
        System.out.println("Animal.getName Call...");
        return this.name;
    }

    public void run() {
        System.out.println("Animal.run...");
    }   
}

// Cat.java
package com.study.jnilearn;
public class Cat extends Animal {

    public Cat(String name) {
        super(name);
        System.out.println("Cat Construct call....");
    }

    @Override
    public String getName() {
        return "My name is " + this.name;
    }

    @Override
    public void run() {
        System.out.println(name + " Cat.run...");
    }
}

// AccessSuperMethod.java
package com.study.jnilearn;
public class AccessSuperMethod {

    public native static void callSuperInstanceMethod(); 

    public static void main(String[] args) {
        callSuperInstanceMethod();
    }

    static {
        System.loadLibrary("AccessSuperMethod");
    }
}</code></pre><p>AccessSuperMethod.c</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// AccessSuperMethod.c</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"com_study_jnilearn_AccessSuperMethod.h"</span></span>

JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_com_study_jnilearn_AccessSuperMethod_callSuperInstanceMethod</span>
  <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass cls<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    jclass cls_cat<span class="token punctuation">;</span>
    jclass cls_animal<span class="token punctuation">;</span>
    jmethodID mid_cat_init<span class="token punctuation">;</span>
    jmethodID mid_run<span class="token punctuation">;</span>
    jmethodID mid_getName<span class="token punctuation">;</span>
    jstring c_str_name<span class="token punctuation">;</span>
    jobject obj_cat<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 1、获取Cat类的class引用</span>
    cls_cat <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"com/study/jnilearn/Cat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cls_cat <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 2、获取Cat的构造方法ID(构造方法的名统一为：&lt;init>)</span>
    mid_cat_init <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls_cat<span class="token punctuation">,</span> <span class="token string">"&lt;init>"</span><span class="token punctuation">,</span> <span class="token string">"(Ljava/lang/String;)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mid_cat_init <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 没有找到只有一个参数为String的构造方法</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 3、创建一个String对象，作为构造方法的参数</span>
    c_str_name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"汤姆猫"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c_str_name <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 创建字符串失败（内存不够）</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//  4、创建Cat对象的实例(调用对象的构造方法并初始化对象)</span>
    obj_cat <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewObject</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>cls_cat<span class="token punctuation">,</span> mid_cat_init<span class="token punctuation">,</span>c_str_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj_cat <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//-------------- 5、调用Cat父类Animal的run和getName方法 --------------</span>
    cls_animal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"com/study/jnilearn/Animal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cls_animal <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 例1： 调用父类的run方法</span>
    mid_run <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls_animal<span class="token punctuation">,</span> <span class="token string">"run"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 获取父类Animal中run方法的id</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mid_run <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 注意：obj_cat是Cat的实例，cls_animal是Animal的Class引用，mid_run是Animal类中的方法ID</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">CallNonvirtualVoidMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj_cat<span class="token punctuation">,</span> cls_animal<span class="token punctuation">,</span> mid_run<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 例2：调用父类的getName方法</span>
    <span class="token comment" spellcheck="true">// 获取父类Animal中getName方法的id</span>
    mid_getName <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls_animal<span class="token punctuation">,</span> <span class="token string">"getName"</span><span class="token punctuation">,</span> <span class="token string">"()Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mid_getName <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    c_str_name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">CallNonvirtualObjectMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj_cat<span class="token punctuation">,</span> cls_animal<span class="token punctuation">,</span> mid_getName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    name <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> c_str_name<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In C: Animal Name is %s\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 释放从java层获取到的字符串所分配的内存</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> c_str_name<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

quit<span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">// 删除局部引用（jobject或jobject的子类才属于引用变量），允许VM释放被局部变量所引用的资源</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls_cat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls_animal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> c_str_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj_cat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="JNI调用性能测试及优化"><a href="#JNI调用性能测试及优化" class="headerlink" title="JNI调用性能测试及优化"></a>JNI调用性能测试及优化</h2><h3 id="性能测试的结论"><a href="#性能测试的结论" class="headerlink" title="性能测试的结论"></a>性能测试的结论</h3><ul>
<li>空方法调用，JNI的性能就要比Java内部调用慢将近5倍</li>
<li>查找class和ID(属性和方法ID)消耗的时间比较大-&gt;如果每次都根据名称查找class和field的话，性能要下降高达40倍，反复调用甚至能到达百万级别<ul>
<li>消耗时间最多的就是查找class</li>
<li>native里保存class和member id是很有必要的</li>
<li>class和member id在一定范围内是稳定的，但在动态加载的class loader下，保存全局的class要么可能失效<h3 id="使用时缓存"><a href="#使用时缓存" class="headerlink" title="使用时缓存"></a>使用时缓存</h3></li>
</ul>
</li>
</ul>
<p><strong>示例：</strong><br>AccessCache.java</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>study<span class="token punctuation">.</span>jnilearn<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccessCache</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> String str <span class="token operator">=</span> <span class="token string">"Hello"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">accessField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 访问str成员变量</span>
    <span class="token keyword">public</span> <span class="token keyword">native</span> String <span class="token function">newString</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> chars<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 根据字符数组和指定长度创建String对象</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        AccessCache accessCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccessCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        accessCache<span class="token punctuation">.</span><span class="token function">nativeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> chars<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">char</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        chars<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'中'</span><span class="token punctuation">;</span>
        chars<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'华'</span><span class="token punctuation">;</span>
        chars<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'人'</span><span class="token punctuation">;</span>
        chars<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'民'</span><span class="token punctuation">;</span>
        chars<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'共'</span><span class="token punctuation">;</span>
        chars<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'和'</span><span class="token punctuation">;</span>
        chars<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'国'</span><span class="token punctuation">;</span>
        String str <span class="token operator">=</span> accessCache<span class="token punctuation">.</span><span class="token function">newString</span><span class="token punctuation">(</span>chars<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"AccessCache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>++AccessCache.c++</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// AccessCache.c</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"com_study_jnilearn_AccessCache.h"</span></span>

JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_com_study_jnilearn_AccessCache_accessField</span>
  <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 第一次访问时将字段存到内存数据区，直到程序结束才会释放，可以起到缓存的作用</span>
    <span class="token keyword">static</span> jfieldID fid_str <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    jclass cls_AccessCache<span class="token punctuation">;</span>
    jstring j_str<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>c_str<span class="token punctuation">;</span>
    cls_AccessCache <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetObjectClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 获取该对象的Class引用</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cls_AccessCache <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 先判断字段ID之前是否已经缓存过，如果已经缓存过则不进行查找</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fid_str <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fid_str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetFieldID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>cls_AccessCache<span class="token punctuation">,</span><span class="token string">"str"</span><span class="token punctuation">,</span><span class="token string">"Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 再次判断是否找到该类的str字段</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fid_str <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    j_str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetObjectField</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> fid_str<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 获取字段的值</span>
    c_str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_str<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c_str <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 内存不够</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In C:\n str = \"%s\"\n"</span><span class="token punctuation">,</span> c_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_str<span class="token punctuation">,</span> c_str<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 释放从从JVM新分配字符串的内存空间</span>

    <span class="token comment" spellcheck="true">// 修改字段的值</span>
    j_str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"12345"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>j_str <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">SetObjectField</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> fid_str<span class="token punctuation">,</span> j_str<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 释放本地引用</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>cls_AccessCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>j_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

JNIEXPORT jstring JNICALL <span class="token function">Java_com_study_jnilearn_AccessCache_newString</span>
<span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">,</span> jcharArray j_char_arr<span class="token punctuation">,</span> jint len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    jcharArray elemArray<span class="token punctuation">;</span>
    jchar <span class="token operator">*</span>chars <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    jstring j_str <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> jclass cls_string <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> jmethodID cid_string <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 注意：这里缓存局引用的做法是错误，这里做为一个反面教材提醒大家，下面会说到。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cls_string <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cls_string <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"java/lang/String"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cls_string <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 缓存String的构造方法ID</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cid_string <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cid_string <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls_string<span class="token punctuation">,</span> <span class="token string">"&lt;init>"</span><span class="token punctuation">,</span> <span class="token string">"([C)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cid_string <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In C array Len: %d\n"</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 创建一个字符数组</span>
    elemArray <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewCharArray</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>elemArray <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 获取数组的指针引用，注意：不能直接将jcharArray作为SetCharArrayRegion函数最后一个参数</span>
    chars <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetCharArrayElements</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> j_char_arr<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>chars <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 将Java字符数组中的内容复制指定长度到新的字符数组中</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">SetCharArrayRegion</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> elemArray<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> chars<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 调用String对象的构造方法，创建一个指定字符数组为内容的String对象</span>
    j_str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewObject</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls_string<span class="token punctuation">,</span> cid_string<span class="token punctuation">,</span> elemArray<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 释放本地引用</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> elemArray<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> j_str<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="类静态初始化缓存"><a href="#类静态初始化缓存" class="headerlink" title="类静态初始化缓存"></a>类静态初始化缓存</h3><p><strong>示例：</strong><br>AccessCache.java</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccessCache</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">initIDs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">nativeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"AccessCache.callback invoked!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        AccessCache accessCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccessCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        accessCache<span class="token punctuation">.</span><span class="token function">nativeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"AccessCache"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initIDs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>++AccessCache.c++</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"com_study_jnilearn_AccessCache.h"</span></span>

jmethodID MID_AccessCache_callback<span class="token punctuation">;</span>

JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_com_study_jnilearn_AccessCache_initIDs</span>
<span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass cls<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"initIDs called!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MID_AccessCache_callback <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>cls<span class="token punctuation">,</span><span class="token string">"callback"</span><span class="token punctuation">,</span><span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_com_study_jnilearn_AccessCache_nativeMethod</span>
<span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In C Java_com_study_jnilearn_AccessCache_nativeMethod called!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">CallVoidMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> MID_AccessCache_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="两种缓存方式比较"><a href="#两种缓存方式比较" class="headerlink" title="两种缓存方式比较"></a>两种缓存方式比较</h3><p>使用时缓存缺点</p>
<ul>
<li>每次都需要检查是否已经缓存该ID或Class引用</li>
<li>只要本地代码依赖于这个ID的值，那么这个类就不会被unload。</li>
<li>如果缓存发生在静态初始化时，当类被unload或reload时，ID会被重新计</li>
</ul>
<h2 id="JNI局部引用、全局引用和弱全局引用"><a href="#JNI局部引用、全局引用和弱全局引用" class="headerlink" title="JNI局部引用、全局引用和弱全局引用"></a><a href="https://blog.csdn.net/xyang81/article/details/44657385" target="_blank" rel="noopener">JNI局部引用、全局引用和弱全局引用</a></h2><h3 id="异常案例：Android-JNI局部引用表溢出：local-reference-table-overflow-max-512"><a href="#异常案例：Android-JNI局部引用表溢出：local-reference-table-overflow-max-512" class="headerlink" title="异常案例：Android JNI局部引用表溢出：local reference table overflow (max=512)"></a>异常案例：<a href="https://blog.csdn.net/xyang81/article/details/44873769" target="_blank" rel="noopener">Android JNI局部引用表溢出：local reference table overflow (max=512)</a></h3><p>Java 调用</p>
<pre class="line-numbers language-Java"><code class="language-Java">    // 返回count个sample相同的字符串数组，并用编号标识，如：sample1，sample2...
    public native String[] getStrings(int count, String sample);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><em>local_ref_overflow_test.c</em></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;jni.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;android/log.h></span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> LOG_TAG "MainActivity"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> LOG_I(...) __android_log_print(ANDROID_LOG_INFO,LOG_TAG, __VA_ARGS__)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> LOG_E(...) __android_log_print(ANDROID_LOG_ERROR, LOG_TAG, __VA_ARGS__)</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> __cplusplus</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

jobjectArray <span class="token function">getStrings</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">,</span> jint count<span class="token punctuation">,</span> jstring sample<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jobjectArray str_array <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    jclass cls_string <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    jmethodID mid_string_init<span class="token punctuation">;</span>
    jobject obj_str <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>c_str_sample <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 保证至少可以创建3个局部引用（str_array，cls_string，obj_str）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">EnsureLocalCapacity</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    c_str_sample <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> sample<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c_str_sample <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cls_string <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"java/lang/String"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cls_string <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 获取String的构造方法</span>
    mid_string_init <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls_string<span class="token punctuation">,</span> <span class="token string">"&lt;init>"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mid_string_init <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>cls_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    obj_str <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewObject</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls_string<span class="token punctuation">,</span> mid_string_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj_str <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>cls_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 创建一个字符串数组</span>
    str_array <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewObjectArray</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> count<span class="token punctuation">,</span> cls_string<span class="token punctuation">,</span> obj_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>str_array <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>cls_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>obj_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 给数组中每个元素赋值</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 初始一下缓冲区</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span> c_str_sample<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jstring newStr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">SetObjectArrayElement</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> str_array<span class="token punctuation">,</span> i<span class="token punctuation">,</span> newStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>newStr<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// Warning: 这里如果不手动释放局部引用，很有可能造成局部引用表溢出</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 释放模板字符串所占的内存</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> sample<span class="token punctuation">,</span> c_str_sample<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 释放局部引用所占用的资源</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> obj_str<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> str_array<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> JNINativeMethod g_methods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span><span class="token string">"getStrings"</span><span class="token punctuation">,</span> <span class="token string">"(ILjava/lang/String;)[Ljava/lang/String;"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>getStrings<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> jclass g_cls_MainActivity <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

JNIEXPORT jint JNICALL <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> vm<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> reserved<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">LOG_I</span><span class="token punctuation">(</span><span class="token string">"JNI_OnLoad method call begin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    JNIEnv<span class="token operator">*</span> env <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    jclass cls <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>vm<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetEnv</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>env<span class="token punctuation">,</span> JNI_VERSION_1_6<span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> JNI_ERR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 查找要加载的本地方法Class引用</span>
    cls <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"com/example/jni/MainActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>cls <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> JNI_ERR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 将class的引用缓存到全局变量中</span>
    g_cls_MainActivity <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewWeakGlobalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> cls<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 手动删除局部引用是个好习惯</span>

    <span class="token comment" spellcheck="true">// 将java中的native方法与本地函数绑定</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">RegisterNatives</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> g_cls_MainActivity<span class="token punctuation">,</span> g_methods<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>g_methods<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>g_methods<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG_I</span><span class="token punctuation">(</span><span class="token string">"JNI_OnLoad method call end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> JNI_VERSION_1_6<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">JNI_OnUnload</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> vm<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> reserved<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">LOG_I</span><span class="token punctuation">(</span><span class="token string">"JNI_OnUnload method call begin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    JNIEnv <span class="token operator">*</span>env <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>vm<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetEnv</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>env<span class="token punctuation">,</span> JNI_VERSION_1_6<span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">UnregisterNatives</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> g_cls_MainActivity<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// so被卸载的时候解除注册</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteWeakGlobalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> g_cls_MainActivity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> __cplusplus</span>
<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="三种引用简介及区别"><a href="#三种引用简介及区别" class="headerlink" title="三种引用简介及区别"></a>三种引用简介及区别</h3><h4 id="局部引用（Local-Reference）"><a href="#局部引用（Local-Reference）" class="headerlink" title="局部引用（Local Reference）"></a>局部引用（Local Reference）</h4><ul>
<li>创建: NewLocalRef 或JNI接口创建（FindClass、NewObject、GetObjectClass和NewCharArray等）</li>
<li>特性：<ul>
<li>会阻止GC回收所引用的对象</li>
<li>不在本地函数中跨函数使用</li>
<li>不能跨线程使用</li>
</ul>
</li>
<li>释放<ul>
<li>函数返回后局部引用所引用的对象会被JVM自动释放</li>
<li>调用DeleteLocalRef<code>(*env)-&gt;DeleteLocalRef(env,local_ref)</code><pre><code>jclass cls_string = (*env)-&gt;FindClass(env, "java/lang/String");
jcharArray charArr = (*env)-&gt;NewCharArray(env, len);
jstring str_obj = (*env)-&gt;NewObject(env, cls_string, cid_string, elemArray);
// 通过NewLocalRef函数创建
jstring str_obj_local_ref = (*env)-&gt;NewLocalRef(env,str_obj);  
....</code></pre><h4 id="全局引用（Global-Reference）"><a href="#全局引用（Global-Reference）" class="headerlink" title="全局引用（Global Reference）"></a>全局引用（Global Reference）</h4></li>
</ul>
</li>
<li>创建： NewGlobalRef</li>
<li>特性： <ul>
<li>会阻GC回收所引用的对象基于局部引用创建</li>
<li>可以跨方法、跨线程使用</li>
<li>VM不会自动释放，必须调用DeleteGlobalRef手动释放<code>(*env)-&gt;DeleteGlobalRef(env,g_cls_string)</code><h4 id="弱全局引用（Weak-Global-Reference）"><a href="#弱全局引用（Weak-Global-Reference）" class="headerlink" title="弱全局引用（Weak Global Reference）"></a>弱全局引用（Weak Global Reference）</h4></li>
</ul>
</li>
<li>创建： NewWeakGlobalRef基于局部引用或全局引用创建</li>
<li>特性：<ul>
<li>不会阻止GC回收所引用的对象</li>
<li>可以跨方法、跨线程使用</li>
</ul>
</li>
<li>释放： 1.比如内存紧张的时候；2. 调用DeleteWeakGlobalRef手动释放<code>(*env)-&gt;DeleteWeakGlobalRef(env,g_cls_string)</code><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> jclass g_cls_string<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">TestFunc</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  jclass cls_string <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"java/lang/String"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  g_cls_string <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">NewWeakGlobalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>cls_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="局部引用"><a href="#局部引用" class="headerlink" title="局部引用"></a>局部引用</h3><h4 id="误区一-用static变量缓存局部变量（变动），造成野指针；"><a href="#误区一-用static变量缓存局部变量（变动），造成野指针；" class="headerlink" title="误区一: 用static变量缓存局部变量（变动），造成野指针；"></a>误区一: 用static变量缓存局部变量（变动），造成野指针；</h4><blockquote>
<p>本地方法返回到Java层之后，如果Java层没有对返回的局部引用使用的话，<font color="red">局部引用就会被JVM自动释放</font></p>
</blockquote>
<h4 id="误区二：局部引用不用释放"><a href="#误区二：局部引用不用释放" class="headerlink" title="误区二：局部引用不用释放"></a>误区二：局部引用不用释放</h4><ul>
<li>Android上的JNI局部引用表最大数量是512个，一些局部引用循环可能溢出<pre class="line-numbers language-Java"><code class="language-Java">for (i = 0; i < len; i++) {
   jstring jstr = (*env)->GetObjectArrayElement(env, arr, i);
   ... /* 使用jstr */
   (*env)->DeleteLocalRef(env, jstr); // 使用完成之后马上释放
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li>调用JNI工具函数时，返回的引用需要手动释放</li>
<li>局部引用占用大资源，但是函数不能立即结束时，如：占用资源后有大量的运算；<pre><code>JNIEXPORT void JNICALL Java_pkg_Cls_func(JNIEnv *env, jobject this)
{
 lref = ...              /* lref引用的是一个大的Java对象 */
 ...                     /* 在这里已经处理完业务逻辑后，这个对象已经使用完了 */
 (*env)-&gt;DeleteLocalRef(env, lref); /* 及时删除这个对这个大对象的引用，GC就可以对它回收，并释放相应的资源*/
 lengthyComputation();   /* 在里有个比较耗时的计算过程 */
 return;                 /* 计算完成之后，函数返回之前所有引用都已经释放 */
}</code></pre><h3 id="管理局部引用"><a href="#管理局部引用" class="headerlink" title="管理局部引用"></a>管理局部引用</h3></li>
<li>JNI提供的引用的生命周期管理<code>EnsureLocalCapacity、NewLocalRef、PushLocalFrame、PopLocalFrame、DeleteLocalRef。</code></li>
<li>JNI函数默认只支持<font color="red">16个局部引用</font>，可以调用EnsureLocalCapacity增加局部引用数量，如果创建成功则返回0，否则创建失败，并抛出OutOfMemoryError异常；<pre><code>/*处理函数逻辑时，确保函数能创建len个局部引用*/
if((*env)-&gt;EnsureLocalCapacity(env,len) != 0) {
 ... /*申请len个局部引用的内存空间失败 OutOfMemoryError*/
 return;
}
for(i=0; i &lt; len; i++) {
 jstring jstr = (*env)-&gt;GetObjectArrayElement(env, arr, i);
 // ... 使用jstr字符串
 /*这里没有删除在for中临时创建的局部引用*/
}</code></pre></li>
<li>Push/PopLocalFrame引用堆栈<pre><code>#define N_REFS ... /*最大局部引用数量*/
for (i = 0; i &lt; len; i++) {
 if ((*env)-&gt;PushLocalFrame(env, N_REFS) != 0) {
     ... /*内存溢出*/
 }
  jstring jstr = (*env)-&gt;GetObjectArrayElement(env, arr, i);
  ... /* 使用jstr */
  (*env)-&gt;PopLocalFrame(env, NULL);
}</code></pre></li>
</ul>
<h3 id="全局引用"><a href="#全局引用" class="headerlink" title="全局引用"></a>全局引用</h3><p>++案例++</p>
<pre><code>JNIEXPORT jstring JNICALL Java_com_study_jnilearn_AccessCache_newString
(JNIEnv *env, jobject obj, jcharArray j_char_arr, jint len)
{
    // ...
    jstring jstr = NULL;
    static jclass cls_string = NULL;
    if (cls_string == NULL) {
        jclass local_cls_string = (*env)-&gt;FindClass(env, "java/lang/String");
        if (cls_string == NULL) {
            return NULL;
        }

        // 将java.lang.String类的Class引用缓存到全局引用当中
        cls_string = (*env)-&gt;NewGlobalRef(env, local_cls_string);

        // 删除局部引用
        (*env)-&gt;DeleteLocalRef(env, local_cls_string);

        // 再次验证全局引用是否创建成功
        if (cls_string == NULL) {
            return NULL;
        }
    }

    // ....
    return jstr;
}</code></pre><h3 id="弱全局引用"><a href="#弱全局引用" class="headerlink" title="弱全局引用"></a>弱全局引用</h3><p><font color="red" face="STHupo">与全局引用很重要不同的一点是，弱引用不会阻止GC回收它引用的对象</font>  </p>
<blockquote>
<p>如果不手动调用这个函数来释放所指向的对象，JVM仍会回收弱引用所指向的对象，但弱引用本身在引用表中所占的内存永远也不会被回收。</p>
</blockquote>
<p>++案例：++</p>
<pre><code>JNIEXPORT void JNICALL
Java_mypkg_MyCls_f(JNIEnv *env, jobject self)
{
    static jclass myCls2 = NULL;
    if (myCls2 == NULL)
    {
        jclass myCls2Local = (*env)-&gt;FindClass(env, "mypkg/MyCls2");
        if (myCls2Local == NULL)
        {
            return; /* 没有找到mypkg/MyCls2这个类 */
        }
        myCls2 = NewWeakGlobalRef(env, myCls2Local);
        if (myCls2 == NULL)
        {
            return; /* 内存溢出 */
        }
    }
    ... /* 使用myCls2的引用 */
}</code></pre><h3 id="引用比较"><a href="#引用比较" class="headerlink" title="引用比较"></a>引用比较</h3><p>jboolean isEqual = (*env)-&gt;IsSameObject(env, obj1, obj2)</p>
<ul>
<li>obj1,obj2: 不管是全局、局部还是弱全局引用</li>
<li>isEqual  JNI_TRUE（或者1）相同，JNI_FALSE（或者0）</li>
<li>JNI中的NULL引用指向JVM中的null对象<ul>
<li>局部或全局引用-&gt; (*env)-&gt;IsSameObject(env, obj, NULL) 或者 obj == NUL判断</li>
<li>弱全局引用 (*env)-&gt;IsSameObject(env, g_obj_ref, NULL) -&gt; 引用中是否仍然指向活动对象<pre><code>jobject local_obj_ref = (*env)-&gt;NewObject(env, xxx_cls,xxx_mid);
jobject g_obj_ref = (*env)-&gt;NewWeakGlobalRef(env, local_ref);
// ... 业务逻辑处理
jboolean isEqual = (*env)-&gt;IsSameObject(env, g_obj_ref, NULL);</code></pre></li>
</ul>
</li>
</ul>
<h3 id="小Tip"><a href="#小Tip" class="headerlink" title="小Tip"></a>小Tip</h3><h4 id="基于全局引用创建一个局引用返回，也同样会阻止GC回收所引用的这个对象"><a href="#基于全局引用创建一个局引用返回，也同样会阻止GC回收所引用的这个对象" class="headerlink" title="基于全局引用创建一个局引用返回，也同样会阻止GC回收所引用的这个对象"></a>基于全局引用创建一个局引用返回，也同样会阻止GC回收所引用的这个对象</h4><h4 id="Push-PopLocalFrame是非常方便且安全的【建议使用】"><a href="#Push-PopLocalFrame是非常方便且安全的【建议使用】" class="headerlink" title="Push/PopLocalFrame是非常方便且安全的【建议使用】"></a>Push/PopLocalFrame是非常方便且安全的【建议使用】</h4><pre class="line-numbers language-java"><code class="language-java">jobject <span class="token function">f</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    jobject result<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">PushLocalFrame</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/* 调用PushLocalFrame获取10个局部引用失败，不需要调用PopLocalFrame */</span>
        <span class="token keyword">return</span> NULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    result <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 创建局部引用result</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/* 返回前先弹出栈顶的frame */</span>
        result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">PopLocalFrame</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">PopLocalFrame</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* 正常返回 */</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="JNI异常处理"><a href="#JNI异常处理" class="headerlink" title="JNI异常处理"></a><a href="https://blog.csdn.net/xyang81/article/details/45770551" target="_blank" rel="noopener">JNI异常处理</a></h2><p>JNI 异常函数列表</p>
<table>
<thead>
<tr>
<th>异常函数</th>
<th>相关描述</th>
</tr>
</thead>
<tbody><tr>
<td>ExceptionCheck</td>
<td>检查是否发生了异常，若有异常返回JNI_TRUE，否则返回JNI_FALSE</td>
</tr>
<tr>
<td>ExceptionOccurred</td>
<td>检查是否发生了异常，若用异常返回该异常的引用，否则返回NULL</td>
</tr>
<tr>
<td>ExceptionDescribe</td>
<td>打印异常的堆栈信息</td>
</tr>
<tr>
<td>ExceptionClear</td>
<td>清除异常堆栈信息</td>
</tr>
<tr>
<td>ThrowNew</td>
<td>在当前线程触发一个异常，并自定义输出异常信息</td>
</tr>
<tr>
<td>Throw</td>
<td>丢弃一个现有的异常对象，在当前线程触发一个新的异常</td>
</tr>
<tr>
<td>FatalError</td>
<td>致命异常，用于输出一个异常信息，并终止当前VM实例（即退出程序）</td>
</tr>
</tbody></table>
<p>void (JNICALL *FatalError) (JNIEnv *env, const char *msg);<br>jint (JNICALL *ThrowNew) (JNIEnv *env, jclass clazz, const char *msg);<br>jint (JNICALL *Throw) (JNIEnv *env, jthrowable obj); </p>
<h3 id="异常处理示例"><a href="#异常处理示例" class="headerlink" title="异常处理示例"></a>异常处理示例</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JNIException</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">doit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">exceptionCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">20</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--->"</span> <span class="token operator">+</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">normalCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"In Java: invoke normalCallback."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">doit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"JNIException"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>++JNIException.c++</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"com_study_jnilearn_JNIException.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_com_study_jnilearn_JNIException_doit</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass cls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    jthrowable exc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    jmethodID mid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>cls<span class="token punctuation">,</span><span class="token string">"exceptionCallback"</span><span class="token punctuation">,</span><span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mid <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">CallStaticVoidMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>cls<span class="token punctuation">,</span>mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"In C: Java_com_study_jnilearn_JNIException_doit-->called!!!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ExceptionCheck</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 检查JNI调用是否有引发异常</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ExceptionDescribe</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ExceptionClear</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 清除引发的异常，在Java层不会打印异常的堆栈信息</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ThrowNew</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span><span class="token string">"java/lang/Exception"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"JNI抛出的异常！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//return;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//如果不return 程序继续执行</span>
    mid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>cls<span class="token punctuation">,</span><span class="token string">"normalCallback"</span><span class="token punctuation">,</span><span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mid <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">CallStaticVoidMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>cls<span class="token punctuation">,</span>mid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>++JNIException.c++ ExceptionOccurred 改造,<code>作用和ExceptionCheck一样</code>，<font color="red" face="STCaiyun">两者的区别在于返回值不一样</font></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">// ....</span>
jthrowable exc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
exc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ExceptionOccurred</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 返回一个指向当前异常对象的引用</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>exc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ExceptionDescribe</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 打印Java层抛出的异常堆栈信息</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ExceptionClear</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//清除异常信息</span>

    <span class="token comment" spellcheck="true">// 抛出我们自己的异常处理</span>
    jclass newExcCls<span class="token punctuation">;</span>
    newExcCls <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">FindClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span><span class="token string">"java/lang/Exception"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newExcCls <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ThrowNew</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> newExcCls<span class="token punctuation">,</span> <span class="token string">"throw from C Code."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">/* 注意释放局部引用 */</span>
     <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> newExcCls<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment" spellcheck="true">/*异常发生后释放资源*/</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// ....</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="异常发生后释放资源"><a href="#异常发生后释放资源" class="headerlink" title="异常发生后释放资源"></a>异常发生后释放资源</h3><pre class="line-numbers language-c"><code class="language-c">JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_pkg_Cls_f</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass cls<span class="token punctuation">,</span> jstring jstr<span class="token punctuation">)</span>
 <span class="token punctuation">{</span>
     <span class="token keyword">const</span> jchar <span class="token operator">*</span>cstr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetStringChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>c_str <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ExceptionCheck</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">/* 异常检查 */</span>
         <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ReleaseStringChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jstr<span class="token punctuation">,</span> cstr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 发生异常后释放前面所分配的内存</span>
         <span class="token keyword">return</span><span class="token punctuation">;</span> 
     <span class="token punctuation">}</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
     <span class="token comment" spellcheck="true">/* 正常返回 */</span>
     <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">ReleaseStringChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jstr<span class="token punctuation">,</span> cstr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://blog.csdn.net/xyang81/article/details/41759643" target="_blank" rel="noopener">JNI/NDK开发指南（开山篇）</a></li>
<li>推荐《Pro Android C++ with the NDK》，中文版名称《Android C++高级编程 使用NDK》</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
            <a href="/tags/实践/" rel="tag"># 实践</a>
          
            <a href="/tags/经验/" rel="tag"># 经验</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/09/11/2019-9-11-custome-view/" rel="next" title="自定义控件其实很简单(笔记一)">
                <i class="fa fa-chevron-left"></i> 自定义控件其实很简单(笔记一)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/09/14/2019-3-21-Java-basic/" rel="prev" title="Java 语法及知识架构笔记；">
                Java 语法及知识架构笔记； <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  
    <div class="comments" id="comments">
      <div class="ds-thread" data-thread-key="2019/09/12/2018-8-15-jni-note/" data-title="JNI/NDK开发指南学习笔记" data-url="http://linz.tech/2019/09/12/2018-8-15-jni-note/">
      </div>
    </div>
  


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="http://cdn.linz.tech/a.gif" alt="北疆">
            
              <p class="site-author-name" itemprop="name">北疆</p>
              <p class="site-description motion-element" itemprop="description">自古以来，所谓豪杰之士，必有过人之节。人情有所不能忍着，匹夫见辱.拔剑而起.挺身而斗，此不足为勇也。天下有大勇者,猝然临之而不惊,无故加之而不怒。而其挟持者甚大，其志甚远也。 ——苏东坡《留候论》</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">87</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/Orange168" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-globe"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://weibo.com/bonanzas" target="_blank" title="微博">
                    
                      <i class="fa fa-fw fa-globe"></i>微博</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="http://www.jianshu.com/users/53927a5b90c8/latest_articles" target="_blank" title="简书">
                    
                      <i class="fa fa-fw fa-globe"></i>简书</a>
                </span>
              
            
          </div>

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-globe"></i>
                常用网站
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://androidweekly.net/" title="Androidweekly English" target="_blank">Androidweekly English</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://androidweekly.cn/" title="Androidweekly Chinese" target="_blank">Androidweekly Chinese</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#JNI开发流程及HelloWorld"><span class="nav-number">1.</span> <span class="nav-text">JNI开发流程及HelloWorld</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI开发主要流程"><span class="nav-number">1.1.</span> <span class="nav-text">JNI开发主要流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#so库加载及相关配置"><span class="nav-number">1.2.</span> <span class="nav-text">so库加载及相关配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JNI数据类型"><span class="nav-number">2.</span> <span class="nav-text">JNI数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#jobject-C-and-C-不同"><span class="nav-number">2.1.</span> <span class="nav-text">jobject C++ and C 不同</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#字符串处理"><span class="nav-number">3.</span> <span class="nav-text">字符串处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#字符三部曲-GET-gt-Release-gt-New"><span class="nav-number">3.1.</span> <span class="nav-text">字符三部曲 GET -&gt; Release -&gt; New</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异常检查"><span class="nav-number">3.2.</span> <span class="nav-text">异常检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#释放字符串"><span class="nav-number">3.3.</span> <span class="nav-text">释放字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NewStringUTF"><span class="nav-number">3.4.</span> <span class="nav-text">NewStringUTF</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他函数"><span class="nav-number">3.5.</span> <span class="nav-text">其他函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Crash错误定位"><span class="nav-number">4.</span> <span class="nav-text">Crash错误定位</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#访问数组（基本类型数组与对象数组）"><span class="nav-number">5.</span> <span class="nav-text">访问数组（基本类型数组与对象数组）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GetIntArrayRegion-【小量的、固定大小的数组】"><span class="nav-number">5.1.</span> <span class="nav-text">GetIntArrayRegion 【小量的、固定大小的数组】</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优化GetIntArrayElements"><span class="nav-number">5.2.</span> <span class="nav-text">优化GetIntArrayElements</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GetIntArrayElements-缺点"><span class="nav-number">5.3.</span> <span class="nav-text">GetIntArrayElements 缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Get-ReleasePrimitiveArrayCritical-暂停GC"><span class="nav-number">5.4.</span> <span class="nav-text">Get/ReleasePrimitiveArrayCritical 暂停GC</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对象数组"><span class="nav-number">6.</span> <span class="nav-text">对象数组</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Get-SetObjectArrayElement"><span class="nav-number">6.1.</span> <span class="nav-text">Get/SetObjectArrayElement</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JVM引用"><span class="nav-number">6.2.</span> <span class="nav-text">JVM引用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-C-访问Java实例方法和静态方法"><span class="nav-number">7.</span> <span class="nav-text">C/C++访问Java实例方法和静态方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#实战案例"><span class="nav-number">7.1.</span> <span class="nav-text">实战案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#callJavaStaticMethod静态方法实现说明"><span class="nav-number">7.2.</span> <span class="nav-text">callJavaStaticMethod静态方法实现说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#callInstanceMethod实例方法实现说明"><span class="nav-number">7.3.</span> <span class="nav-text">callInstanceMethod实例方法实现说明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#相关的函数CallXXXMethod"><span class="nav-number">7.3.1.</span> <span class="nav-text">相关的函数CallXXXMethod</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法签名"><span class="nav-number">7.4.</span> <span class="nav-text">方法签名</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#方法签名的格式"><span class="nav-number">7.4.1.</span> <span class="nav-text">方法签名的格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基本类型映射关系"><span class="nav-number">7.4.2.</span> <span class="nav-text">基本类型映射关系</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结"><span class="nav-number">7.5.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#C-C-访问Java实例Field和static-Field"><span class="nav-number">8.</span> <span class="nav-text">C/C++访问Java实例Field和static Field</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#实战Demo"><span class="nav-number">8.1.</span> <span class="nav-text">实战Demo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问实例Field"><span class="nav-number">8.2.</span> <span class="nav-text">访问实例Field</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#GetXXField"><span class="nav-number">8.2.1.</span> <span class="nav-text">GetXXField</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问静态变量"><span class="nav-number">8.3.</span> <span class="nav-text">访问静态变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调用构造方法和父类实例方法"><span class="nav-number">9.</span> <span class="nav-text">调用构造方法和父类实例方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#实例"><span class="nav-number">9.1.</span> <span class="nav-text">实例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JNI调用性能测试及优化"><span class="nav-number">10.</span> <span class="nav-text">JNI调用性能测试及优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#性能测试的结论"><span class="nav-number">10.1.</span> <span class="nav-text">性能测试的结论</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用时缓存"><span class="nav-number">10.2.</span> <span class="nav-text">使用时缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#类静态初始化缓存"><span class="nav-number">10.3.</span> <span class="nav-text">类静态初始化缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#两种缓存方式比较"><span class="nav-number">10.4.</span> <span class="nav-text">两种缓存方式比较</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JNI局部引用、全局引用和弱全局引用"><span class="nav-number">11.</span> <span class="nav-text">JNI局部引用、全局引用和弱全局引用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#异常案例：Android-JNI局部引用表溢出：local-reference-table-overflow-max-512"><span class="nav-number">11.1.</span> <span class="nav-text">异常案例：Android JNI局部引用表溢出：local reference table overflow (max=512)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三种引用简介及区别"><span class="nav-number">11.2.</span> <span class="nav-text">三种引用简介及区别</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#局部引用（Local-Reference）"><span class="nav-number">11.2.1.</span> <span class="nav-text">局部引用（Local Reference）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#全局引用（Global-Reference）"><span class="nav-number">11.2.2.</span> <span class="nav-text">全局引用（Global Reference）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#弱全局引用（Weak-Global-Reference）"><span class="nav-number">11.2.3.</span> <span class="nav-text">弱全局引用（Weak Global Reference）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#局部引用"><span class="nav-number">11.3.</span> <span class="nav-text">局部引用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#误区一-用static变量缓存局部变量（变动），造成野指针；"><span class="nav-number">11.3.1.</span> <span class="nav-text">误区一: 用static变量缓存局部变量（变动），造成野指针；</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#误区二：局部引用不用释放"><span class="nav-number">11.3.2.</span> <span class="nav-text">误区二：局部引用不用释放</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#管理局部引用"><span class="nav-number">11.4.</span> <span class="nav-text">管理局部引用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#全局引用"><span class="nav-number">11.5.</span> <span class="nav-text">全局引用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#弱全局引用"><span class="nav-number">11.6.</span> <span class="nav-text">弱全局引用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#引用比较"><span class="nav-number">11.7.</span> <span class="nav-text">引用比较</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小Tip"><span class="nav-number">11.8.</span> <span class="nav-text">小Tip</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基于全局引用创建一个局引用返回，也同样会阻止GC回收所引用的这个对象"><span class="nav-number">11.8.1.</span> <span class="nav-text">基于全局引用创建一个局引用返回，也同样会阻止GC回收所引用的这个对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Push-PopLocalFrame是非常方便且安全的【建议使用】"><span class="nav-number">11.8.2.</span> <span class="nav-text">Push/PopLocalFrame是非常方便且安全的【建议使用】</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JNI异常处理"><span class="nav-number">12.</span> <span class="nav-text">JNI异常处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#异常处理示例"><span class="nav-number">12.1.</span> <span class="nav-text">异常处理示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异常发生后释放资源"><span class="nav-number">12.2.</span> <span class="nav-text">异常发生后释放资源</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">13.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">北疆</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>





    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">本站访客数<span id="busuanzi_value_site_uv"></span>人</span>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zhilinchn"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  
















  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === '') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
